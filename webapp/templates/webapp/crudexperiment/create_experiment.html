{% extends "webapp/crudexperiment/base_experiment.html" %}
{% block content %}
{%load static from staticfiles%}
<div class="container-fluid text-center">    
        <div class="row content">
          <div class="col-sm-2 sidenav">

         
          </div>
        <div class="col-sm-9  col-md-9 col-lg-9 col-xs-9 text-left" > 
            <h1>Create Experiment</h1> <!-- Show Experiment Id here e.g. ses-007 (admin id) + experiment no. (5 digits)-->
            <form action="{%url 'createexp'%}">
            <!--No of Experiments:<br> --> 
            <input type="hidden" value="1" id="nofexp" name="Experiments"/>
            No of subjects capicity:<br>  
            <input type="text" value="50" id="nofsc" name="subjects"/>
              <!-- Fetching feature names from platform_feature model.  
              Then Creating check boxes for selection. If Check box is clicked then An ajax call
              would be made inorder to fetch further details of that feature. After which more 
              checkbox options will be shown based on the further details. e.g pruned/full.
              -->
              <input type="submit" value="Submit">
            </form>
            {% for feature in platformfeatobj%}
            
            <input type="checkbox"  id='{{feature.id}}' action='{%url "createexp"%}' method="post" 
            value="{{feature.feature_name}}" 
            onclick="outerCheckBox($(this).attr('value'),$(this).attr('id'))">{{feature.feature_name}} 
            <div id='{{feature.id}}-innercheckboxdiv' class='innerchecksboxdivs' title='{{feature.feature_name}}'>
              
            </div>
            </input>
            <br>
            
            {%endfor%}
           
            
            <li><a href='{% url "datadefined" %}'>data defined Batches</a></li>
            <li><a href=#>admin defined  </a></li>
          </div>
          <div class="col-sm-1 sidenav">
          
          </div>
        </div>
      </div>
      <footer>
		
            <div class="container-fluid" style='margin-left:15px'>
                <p><a href="#" target="blank">Contact</a> | <a href="#" target="blank">LinkedIn1</a> | <a href="#" target="blank">Twitter</a> | <a href="#" target="blank">Google+</a></p>
            </div>
    </footer>	
<script>
      //Global Variable
      var dict = {};
      var arr_subdetails=[];
      // When the page will this will be the first javascript function that will be called. 
       $(document).ready(function () {
         // This Will hide all the divs with class=innerchecksboxdivs
        $('.innerchecksboxdivs').hide();
        });
      // Outercheckbox function 
      // This function gets 2 arguments when called val and id attribute of input type=checkbox
      // having id based on the feature.id.
      // It is called through onclick function. 
      function outerCheckBox(outercheckval,outercheckid) {
        console.log("checkbox");
        console.log(outercheckval);
        console.log(outercheckid);
      // Ajax call is made to send the outercheckboxid to the controller. 
      // The controller will fetch the sub-details of that feature from model and return back in
      // in success function. 
      // Success funtion will first check if the outercheckbox is checked or unchecked. 
      // If unchecked it'll simply hide the innercheckboxdiv or do nothing as by default its hidden.
      // else will populate data in that div and show to user.  
       $.ajax({
       type: 'POST',
       dataType: "json",
       'data': {
       'd': JSON.stringify(outercheckval),
       'csrfmiddlewaretoken': '{{ csrf_token }}',
      },
      // the ajax call is sent to subdetails url name in the post function.  
       url: "{% url 'subdetails' %}",
       success: function(data){
       console.log("success");
       var outerckbox = $('#'+outercheckid);
       console.log(outerckbox);
        // checking if the user has checked or not. 
        if (outerckbox.is(':checked')) {
           alert('You Checked');
           console.log('asdasd',outercheckval);
           console.log(data)
           //dict[outercheckval]=data
           if (data==null){
             dict[outercheckval]=[0,1]
           }
           console.log(dict)
            // calling innercheckboxdivs. 
            // these divs basically come after outercheckbox that contain innerchecks.
            // outercheck id and the data is sent to this function.
            // This function shows the innerChecksdivs after including and populating data in 
            // innerchecks.
            // todo: change the name of innercheckboxdivs name as it seems like it is refering to
            // div inside inner checks...
            showInnerCheckBoxDivs(outercheckid,data);
        } else {
            alert('You Un-Checked it');
            // For now its purpose is simply to hide the innercheckdivs.  
            hideInnerCheckBoxDivs(outercheckid);
            console.log(outercheckval);
            dict[outercheckval]=null;
            if (dict[outercheckval]==null  ){
              delete dict[outercheckval];
              console.log('in else condition');  
           }
           console.log(dict)

        }
       }
       }); 
      }
      function showInnerCheckBoxDivs(outercheckid,data){
        console.log('#'+outercheckid+'-innercheckboxdiv')
        // Creating inner checks and populating them with data. 
        for (var o in data){
          console.log('A',o);
          var $ctrl =  $(document.createElement("input")).attr({
                    id:  o+'-innercheckbox',
                    name:  '',
                    value: data[o],
                    text :'',
                    type:  'checkbox',
                    checked:false,
                    onclick:"innerCheckBox($(this).attr('value'),$(this).attr('id'),\
                    $(this).parent().attr('title')\
                    )"
            })
        // adding input attributes to a div
        $('#'+outercheckid+'-innercheckboxdiv').append($ctrl);
        $('#'+outercheckid+'-innercheckboxdiv').append(data[o]);
        $('#'+outercheckid+'-innercheckboxdiv').show();
        }
      }
      // function that hides the divs containing innercheckbox
      function hideInnerCheckBoxDivs(outercheckid){
        $('#'+outercheckid+'-innercheckboxdiv').hide();
        $('#'+outercheckid+'-innercheckboxdiv').empty();

      }
      // once the onclick function=>(innercheckbox) of inner checks are called it 
      // shows three things. innercheck value , id and outer check value/title.
      function innerCheckBox(innercheckval,innercheckid,outercheckdivtitle){
        //console.log(innercheckval,innercheckid,outercheckdivtitle);
        var innercheckboxid = $('#'+innercheckid);
        console.log("innercheckbox-",innercheckboxid );
        // checking if the user has checked or not. 
        
        
        if (innercheckboxid.is(':checked')) {
            if (dict[outercheckdivtitle] == null) {
                   dict[outercheckdivtitle]=[]
               }   
            alert('You have Checked innercheckbox');
            arr_subdetails=dict[outercheckdivtitle];
            console.log('Specific dict in Checked',dict[outercheckdivtitle]);
            console.log('insert',arr_subdetails);
            arr_subdetails.push(innercheckval);
            dict[outercheckdivtitle]=arr_subdetails;
            console.log('arr',arr_subdetails);
            console.log('All dict in checked condition.',dict)
            
        } else {

            alert('You UNNNChecked innercheckbox');
            arr_subdetails=dict[outercheckdivtitle];
            console.log('Specific dict in UnChecked',dict[outercheckdivtitle]);
            console.log('arr',arr_subdetails);
            console.log(innercheckval);
            var index = $.inArray(innercheckval, arr_subdetails);
              if (index != -1) {
                  var removedvalue=arr_subdetails.splice(index, 1);
                  console.log('removedvalue',removedvalue);
              }

            console.log('del arr',arr_subdetails);
            if (arr_subdetails.length==0){
              delete  dict[outercheckdivtitle];
              console.log('condition check');
              console.log('deleted dic',dict);


            }
            else{ 
              dict[outercheckdivtitle]=arr_subdetails;
              console.log('dict',dict);
               
            }
           
        }
      }
</script>
{%endblock%}