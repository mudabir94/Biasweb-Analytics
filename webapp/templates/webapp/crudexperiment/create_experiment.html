{% extends "webapp/crudexperiment/base_experiment.html" %}
{% block content %}
{%load static from staticfiles%}
<div class="container-fluid text-center"> 
    <!-- MAIN ROW CONTENT DIV  -->
    <div class="row content">
        <!-- 1st SIDEBAR COL DIV -->
        <div class="col-sm-2 sidenav" style='background:teal'></div>
        <div class="col-sm-9  col-md-9 col-lg-9 col-xs-9 text-left" > 
            <!-- CREATE EXP ROW DIV  -->
            <div class ="row-fluid">     
                    <div class ="row">   
                        <div class='col-md-12' >
                        <!-- <p1>Create Experiment </p1> Show Experiment Id here e.g. ses-007 (admin id) + experiment no. (5 digits) -->
                        </div>  
                    </div>
                    <div class ="row"> 
                        <div class='col-md-12' id='cr_exp_header' >    
                        <!-- <p1>Admin id {{admin_id}}</p1> -->
                        </div>                            
                    </div>
                    <div class ="row"> 
                        <div class='col-md-12' >    
                        <!-- <p1>Experiment id {{experiment_id}}</p1> -->
                        </div>                            
                    </div>
            </div>
            <!-- CUSTOM NAV ROW DIV -->
            <div class='row-fluid'>
                <div class='row' id='custom_nav_div' >
                <div class='col-md-4'><button id='ftlvl' class='custom_nav_btn active 'onclick='showFeatureLvls($(this))'>Feature Levels</button> </div>
                <div class='col-md-4'><button id='btchmng' class='custom_nav_btn'onclick='showBatchManagement()'>Batch Management</button></div>
                <div class='col-md-4'><button id='blkmng' class='custom_nav_btn' onclick='showBlockManagement()'>Block Management</button></div>
                </div>    
            </div>
            <br>
            <!--FEATURES LEVELS ROW DIV -->
            <div class='row-fluid' style="background:peru;" id='feat_lvl_div'>
                <div class='row'>
                    <div class='col-md-4'>
                            <p1><b>Select features to enable:</b></p1>
                    {% for feature in platformfeatobj%}
                        <div class='row-fluid'>
                            <div class='col-md-12'>
                                <input type="checkbox"  id='{{feature.id}}' action='{%url "createexp"%}'
                                        method="post" 
                                        value="{{feature.feature_symbol}}" 
                                        onclick="outerCheckBox($(this).attr('value'),$(this).attr('id'))">
                                        {{feature.feature_name}} 
                                        <div  id='{{feature.id}}-innercheckboxdiv' class='innerchecksboxdivs' title='{{feature.feature_symbol}}'>
                                        </div>
                                </input>
                                <br>
                            </div>
                        </div>
                        {%endfor%}
                    
                        <div class='row-fluid'>

                            <button onclick='sendFeatureLevels()'> Set Feature Levels </button>
    
                        </div> 
                    </div>

                    <div class='col-md-6' style='background: green'  >
                        <div class='row'>
                            <div class='col-md-12'>
                            </div>
                        </div>
                        <div class='row'>
                            <div class='col-md-12'>
                                <div class='table-responsive' id='generated_blocks'></div>
                            </div>    
                        </div>
                       

                    </div>
                    
                    <div class='col-md-2' style='background: lightgray'>
                        <div class='row'>
                            <div class='col-md-3'></div>
                            <div class='col-md-3'></div>
                            <div class='col-md-6'>  <button style="float: right;"onclick='showImportSubdiv()'>NEXT</button></div>

                            
                        </div>
                    </div>
                </div>
            </div>  
            <br>
           
            <!-- IMPORT SUBJECT DIV ROW DIV-->
            <div class='row-fluid' style="background: rgb(209, 91, 150)" id='importSubdiv'> 
                    <div class='row'>
                        <div class='col-md-1'>
                            <div class='row-fluid'></div>
                        </div>
                        <div class='col-md-5'>
                            <!-- Import Subjects Div -->
                            <div class=row>
                                    <label>Import Subjects</label>
                                    <br>
                                    <input type="file"  id="fileUpload" onclick="chooseFileFunc()"/>
                                    <input type="button" id="upload" value="Upload" />
                            </div>
                            <hr />
                            <!--SET COLUMN LABELS SELECTORS-->
                            <div class='row'>
                                    <div class='col-md-12'  >
                                            <div class='row'>
                                                    <div class='col-md-6' ><div class='map_select_label' id='custom_label_id'>Custom id</div> </div>
                                                    <div class='col-md-6'> <div class="show_select_tag" id="show_s1"></div></div>
                                            </div>
                                    </div>
                                    <div class='col-md-12' >
                                            <div class='row'>
                                                    <div class='col-md-6' > <div class='map_select_label' id='email_label_id'>Email</div></div>
                                                    <div class='col-md-6'> <div class="show_select_tag" id="show_s2"></div></div>
                                            </div>
                                    </div>
                                    <div class='col-md-12' >
                                            <div class='row'>
                                                    <div class='col-md-6' > <div class='map_select_label' id='batchT_label_id'>Batch Title</div></div>
                                                    <div class='col-md-6'> <div class="show_select_tag" id="show_s3"></div></div>
                                            </div>
                                    </div>
                            </div>
                            <!-- Proceed Btn Div -->
                            <div class='row'>
                                    <div class='col-md-12' >
                                        <div class='col-md-6' > </div>
                                        <div class='col-md-6'> <div id='proceedbtndiv'></div></div>
                                    </div>
                            </div>
                        
                            <!-- Self Defined DIV -->
                            <div class='row-fluid' >
                                        <!-- Self Button -->
                                        <div class='row-fluid' >
                                                <div class='col-md-12' id='selfbuttondiv'>
                                                
                                                </div>
                                        </div>
                                        
                                        <!-- Self defined Input Fields -->
                                        <div class='row-fluid' >
                                            <div class='col-md-12'  id='self-defined'>
                                                    <hr/>
                                                    <div class='row'>
                                                        <div class='col-md-6' id='batchtitle_name'></div>
                                                        <div class='col-md-6' id='batchtitle_input'></div>

                                                    </div>
                                                    <div class='row'>
                                                        <div class='col-md-6' id='batchnum_name'></div>
                                                        <div class='col-md-6' id='batchnum_input'></div>
                                                    </div>
                                                    <div class='row'>
                                                        <div class='col-md-6' id='batchlabel_name'></div>
                                                        <div class='col-md-6' id='batchlabel_input'></div>
                                                    </div>
                                                    <div class='row'>
                                                        <div class='col-md-6' ></div>
                                                        <div class='col-md-6' id='self-assignbuttondiv'></div>
                                                    </div>

                                            </div>
                                        </div>
                            </div>
                            <!-- PreDefined Div-->
                            <div class='row-fluid'>
                                    <div class='row-fluid' >
                                        <div class='col-md-12' id='predefbuttondiv'>
                                            
                                        </div>
                                    </div>

                                    <div class='row-fluid' >

                                        <div class='col-md-12' id='pre-defined'> 
                                            <hr/>
                                            <div class='row'>
                                                    <div class='col-md-6'><div id='custom_label_id1'></div></div>
                                                    <div class='col-md-6'><div id='custom_tag_id1'></div></div>
                                            </div>
                                            <div class='row'>
                                                    <div class='col-md-6'><div id='email_label_id1'></div></div>
                                                    <div class='col-md-6'><div id='email_tag_id1'></div></div>
                                            </div>
                                            <div class='row'>
                                                    <div class='col-md-6'><div id='batchT_label_id1'></div></div>
                                                    <div class='col-md-6'><div id='batchT_tag_id1'></div></div>
                                            </div>
                                            <!-- <div class='row'>
                                                    <div class='col-md-12' id="pre-batchtitletext"></div>
                                            </div>
                                            <div class='row'>
                                                <div class='col-md-12' id="pre-RadioDiv"></div>
                                            </div>-->
                                            <div class='row'>
                                                    <div class='col-md-6' ></div>
                                                    <div class='col-md-6' id="pre-assignbuttondiv"></div>
                                            </div> 
                                        </div> 
                                
                                    </div>
                            </div>
                        </div>
                      
                        <div class='col-md-6'>
                            <div class='row-fluid'>
                                <div class='col-md-12'>
                                            <div>Batch Size</div>
                                </div>
                            </div>
                            <div class='row-fluid'>
                                <div class='col-md-12'>  
                                        <div class='batchsize_div'></div>
                                </div>
                            </div>
                            <br>  
                            
                        </div>      
                    </div> 
                    <!-- Row Ending -->
                    <br>   
            </div>
            <!--Hiding Feature level  -->
            <!-- <div class='row-fluid' id='dispFileFeatLvldiv' style='background:aqua'>
                    <div class='col-md-1'></div>
                    
                   
                     <div class='col-md-5'> 
                             <div class='row-fluid'>
                                     <div class='col-md-12'>
                                          <label> Feature Levels</label>
                                     </div>
                                 </div>
                                 <div class='row-fluid'>
                                     <div class='col-md-12'>

                                     </div>    
                                 </div>
                                 <div class='row-fluid'>
                                         <div class='col-md-12' >
                                             <div class='displayfeaturelevelTable'>

                                             </div>
                                         </div>
                                 </div>
                     </div>
                     <div class='col-md-1'></div>
            </div> -->
            <!--  -->
            <div class='row-fluid' id='dataDiv' style="background:lawngreen" >
                  
                            <div class='row-fluid'>
                                <label> Uploaded data from file. </label>
                            </div>
                             <!--DATA & DETAILS EDITING DISPLAY SECTION-->
                            <div class='row-fluid' >
                                <div class='col-md-12'>
                                    <div id="showfiledatadiv">
                                     </div>
                                </div>
                            </div>
                    
            </div>
            <!--  -->
            <div class='row-fluid' id='subj_split_batch_rowdiv'>
                                    
                    <div class='col-md-12'>
                            <div class='row-fluid'>
                                <label>Subject Split to Batches</label>
                            </div>
                            <div class='row-fluid'>
                                <div id='subj_split_batch' class=" table-bordered">
                                </div>
                            </div>
                    </div>

            </div>

             <!--BLOCK ASSIGNMENT ROW DIV-->
            <div class='row-fluid' id='block_assign_row_div' style="background: rgb(255, 105, 6)">
                    <div class='row'>
                        <div class="col-md-6" >
                                <br>
                                <br>
                                    <div class='row-fluid'>

                                        <p1><b><i>Assign subjects to latest set of feature blocks?</b></i></p1>
                                        <br>
                                        <br>
                                        <button onclick='assignToBlocks()'> Assign to Blocks </button>
                                    </div>
                        </div>
                    </div>
            </div>
               
                <br>
            <!--MY OUTPUT DIV ROW DIV-->
            <div class='row-fluid' id='blkoutputsDiv' style='background:chartreuse'>  
                      
                        <div class='row'>
                                <!-- <div class='col-md-6'>
                                    <div id='blocksListDiv'></div>
                                </div> -->
                                <div class='col-md-12'>
                                   
                                    <div id='blocksBreakUpDiv'></div>
                                    
                                </div>
                        </div>
            </div> 
            
            <div class='row-fluid' id='batchmngprvbtn'>
                    <div class='col-md-1'><button onclick="showFeatLvlDiv()">Previous</button></div>
                    <div class='col-md-5'></div>
                    <div class='col-md-6'></div>
            </div>
        </div>
        <div class="col-sm-1 sidenav" style='background:yellow'>side bar</div>   
    </div>
</div>
      <!-- <footer>
		
          <div class="container-fluid" style='margin-left:15px'>
              <p><a href="#" target="blank">Contact</a> | <a href="#" target="blank">LinkedIn1</a> | <a href="#" target="blank">Twitter</a> | <a href="#" target="blank">Google+</a></p>
          </div>
     </footer>	 -->
<script>

//Global Variable
var dict = {};
var arr_feature_levels=[];
var globalfiledatalist=[];
var exp_id = '{{sess_expId}}';
var custom_exp_id='{{sess_custExpId}}';
var block_list = [];
var header = document.getElementById("custom_nav_div");
var btns = header.getElementsByClassName("custom_nav_btn");
// variable to save outer and inner check box div info. for pre populating. 
var checkbox_id_dict={};

// When the page will this will be the first javascript function that will be called. 
$(document).ready(function () {
 var blockList = JSON.parse(window.localStorage.getItem("blockList")); 
 if ( blockList===null){
        console.log('block list empty');
    }
else{
     table_blocks=draw_block_table(blockList)
     display_blocktable(table_blocks);
}
   

// This Will hide all the divs with class=innerchecksboxdivs

$('.innerchecksboxdivs').hide();
$('.map_select_label').hide();
$('.show_select_tag').hide();

$('#self-defined').hide();
$('#pre-defined').hide();
$('#selfbuttondiv').hide();
$('#prebuttondiv').hide();
$('#upload').prop('disabled',true);
$('#importSubdiv').hide();
$('#dispFileFeatLvldiv').hide();
$('#subj_split_batch_rowdiv').hide();
$('#block_assign_row_div').hide();

$('#batchmngprvbtn').hide();
$('#dataDiv').hide();
//TODO@MUDABIR:
if(exp_id===""){
    $('#feat_lvl_div').hide();
    //test to see if session exp empty
    //if not, then alert that session exists
    //if ok, load the experiment details as were
    //else, set sess_expId to None
} else {
    let contin = confirm("Continue working on Experiment: "+custom_exp_id+"?");
     if(contin===false){

        //  alert("TO BE IMPLEMENTED AS AJAX CALL")
        alert ("Discarding everything. ")
        
         localStorage.removeItem("blockList");
         localStorage.removeItem("checkbox_id_dict");
         localStorage.removeItem("feat_dict");

     }else{
         showExpWIP()


     }
}
// TESTING 
dict=JSON.parse(window.localStorage.getItem("feat_dict")); 
checkbox_id_dict=JSON.parse(window.localStorage.getItem("checkbox_id_dict")); 




if (dict==null ){
    dict={};

//     dict['I']=['I.1'];
//     dict['R']=['R.1'];
//     dict['W']=['W.direct'];
//     dict['A']=['A.all','A.user']
//     dict['C']=['C.full']
 }
else {
    displayfeaturelevelTable();
}
if (checkbox_id_dict==null){
    checkbox_id_dict={};

    // checkbox_id_dict[1]=['1-innercheckbox-1'];
    // checkbox_id_dict[2]=['1-innercheckbox-2'];
    // checkbox_id_dict[3]=['0-innercheckbox-3'];
    // checkbox_id_dict[4]=['0-innercheckbox-4','3-innercheckbox-4'];
    // checkbox_id_dict[5]=['0-innercheckbox-5'];







}

console.log('dict',dict);console.log('checkbox_id_dict',checkbox_id_dict);

// Filling outer checkboxes when the page is loaded. 
    // LOGIC TO BE IMPLEMENTED. 
    // First Check if checbox_id_dict is empty if not then run following, else do nothing. 
    // Then Run a SEPERATE OUTERCHECKBOX function that generates checkboxes exactly like the original one, but doesnt store data in dict.
    // Which will run a seperate showinnerbox function to populate the innerchecboxes. 
if (checkbox_id_dict!={}){
for (var key in checkbox_id_dict){
    console.log('cheCKebox value',checkbox_id_dict[key]);
    console.log('key',key);
    var outercheckbox = document.getElementById(key);
    outercheckbox.checked = true; 
    outerCheckBox_Stored( outercheckbox.getAttribute('value') ,key )
}
}

});

function outerCheckBox_Stored(outercheckval,outercheckid) {
console.log("checkbox");
console.log(outercheckval);
console.log(outercheckid);
// Ajax call is made to send the outercheckboxid to the controller. 
// The controller will fetch the sub-details of that feature from model and return back in
// in success function. 
// Success funtion will first check if the outercheckbox is checked or unchecked. 
// If unchecked it'll simply hide the innercheckboxdiv or do nothing as by default its hidden.
// else will populate data in that div and show to user.  
$.ajax({
type: 'POST',
dataType: "json",
'data': {
'd': JSON.stringify(outercheckval),
'csrfmiddlewaretoken': '{{ csrf_token }}',
},
// the ajax call is sent to subdetails url name in the post function.  
url: "{% url 'subdetails' %}",
success: function(data){
console.log("success");
var outerckbox = $('#'+outercheckid);
console.log('outercheckbox obj',outerckbox);
        // For this Function IF CONDITION SHOULD ALWAYS BE TRUE.. 
        if (outerckbox.is(':checked')) {
            // alert('You Checked');
            console.log('outercheckval',outercheckval);
            console.log('data retrieved',data)
            
            //checkbox_id_dict[outercheckid]=[];
            showInnerCheckBoxDivs_Stored(outercheckid,data);
            // updateFeatureLvls();
        } 
        else {
            // alert('You Un-Checked it');
            // For now its purpose is simply to hide the innercheckdivs.  
            hideInnerCheckBoxDivs(outercheckid);
            // console.log(outercheckval);
            // dict[outercheckval]=null;
            // if (dict[outercheckval]==null  ){
            //     delete dict[outercheckval];
            //     console.log('in else condition');  
            // }
            // console.log(dict)
            // updateFeatureLvls();
        }
}
}); 
}


function showInnerCheckBoxDivs_Stored(outercheckid,data){
console.log('#'+outercheckid+'-innercheckboxdiv')
// Creating inner checks and populating them with data. 
console.log(checkbox_id_dict)
var k=checkbox_id_dict;
var innercheckbox_id_list=[];
var value_found=''
for (var o in data){
        console.log('A',o);    
        var innercheck_element =  $(document.createElement("input")).attr({
                id: o +'-innercheckbox-'+outercheckid,
                name:  '',
                value: data[o],
                text :'',
                type:  'checkbox',
                checked:true,
                onclick:"innerCheckBox($(this).attr('value'),$(this).attr('id'),\
                $(this).parent().attr('title'), $(this).parent().attr('id')\
                )"
            
        })
        var inner_id=innercheck_element.attr('id')
        console.log('inner_id',inner_id)
        console.log('outercheckid',outercheckid);
        console.log('INNERCHECK FUNC CHECKBOX DICT',k);
        console.log('array',k[outercheckid])

        var stored_innercheckbox_id_list=k[outercheckid]
        console.log('stored_innercheckbox_id_list',stored_innercheckbox_id_list);
        delete stored_innercheckbox_id_list[value_found];
           console.log(stored_innercheckbox_id_list)
           if (jQuery.isEmptyObject(stored_innercheckbox_id_list)){
           
            innercheck_element.prop('checked',false)
           }
           else {
                for (var value_id in stored_innercheckbox_id_list){
                    
                    console.log("stored_innercheckbox_id_list[value_id]",stored_innercheckbox_id_list[value_id]);
                    console.log ('inner_id',inner_id)
                            if (stored_innercheckbox_id_list[value_id]===inner_id)
                            {    console.log('in if cond')
                                innercheckbox_id_list.push(inner_id)

                                value_found=value_id
                                console.log("stored_innercheckbox_id_list",stored_innercheckbox_id_list);
                                
                                break;
                            }
                            else{
                                console.log('in else cond')
                                innercheck_element.prop('checked',false)

                            }
                }
           }
        // adding input attributes to a div
        $('#'+outercheckid+'-innercheckboxdiv').append(innercheck_element);
        $('#'+outercheckid+'-innercheckboxdiv').append(data[o]);
        $('#'+outercheckid+'-innercheckboxdiv').show();
    }
    checkbox_id_dict[outercheckid]=innercheckbox_id_list;
    console.log('DICTionary',dict);

    console.log('All innercheck boxid added to checkbox dict',checkbox_id_dict);
}



// Code for changing the background colour of the custom_nav_bt
for (var i = 0; i < btns.length; i++) {
      btns[i].addEventListener("click", function() {
    var current = document.getElementsByClassName("active");
    current[0].className = current[0].className.replace(" active", "");
    this.className += " active";
  });
// Uploading file Function . 
function showImportSubdiv(){
    // setting current active btn.
    var current=$('#ftlvl')
    current.prop('class',current.attr('class').replace('active',""));
    $('#btchmng').prop('class', 'custom_nav_btn active');
    
    $('btchmng').className += " active";
    
    $('#feat_lvl_div').hide();
    $('#importSubdiv').show(1000);
    $('#batchmngprvbtn').show();


}
function showFeatLvlDiv(){
  
   
    $('#importSubdiv').hide();
    $('#block_assign_row_div').hide();
    $('#dataDiv').hide();
    $('#batchmngprvbtn').hide();
    $('#dataDiv').hide();
    $('#feat_lvl_div').show( 1000);
    
    var current=$('#btchmng')
    current.prop('class',current.attr('class').replace('active',""));
    $('#ftlvl').prop('class', 'custom_nav_btn active');
}


}
function displayfeaturelevelTable(){
    $('#dispFileFeatLvldiv').show();
    makeFeatureLvldicTable();

}
function makeFeatureLvldicTable(){
    var table=document.createElement('TABLE');
    table.setAttribute('class','table table-striped table-bordered')
    var thead=document.createElement('THEAD');
    table.appendChild(thead);
    var tbody=document.createElement('TBODY');
    table.appendChild(tbody);
    var trh=document.createElement('TR');
    var th=document.createElement('TH')
    thead.appendChild(trh)
    th.append('Feature Symbol')
    trh.appendChild(th)
    var th=document.createElement('TH')
    th.append('Feature Levels')
    trh.appendChild(th)
    console.log('amsdkmakdmakmdkamskmdkamsd')
    if (dict==='{}'){
        console.log('emoty tabel');
    }
    else{
        for (var row in dict){
      
        var tr=document.createElement('TR');
        tbody.appendChild(tr)
        var td=document.createElement('TD')
        td.append(row)
      
        tr.appendChild(td)
        var td=document.createElement('TD')
        
        td.append(dict[row])
        tr.appendChild(td)
         }
    }
    
    console.log(table)
    $(table).appendTo("#displayfeaturelevelTablediv");
    $(table).appendTo(".displayfeaturelevelTable");
    window.localStorage.setItem("dispfeatlevels", JSON.stringify(dict));
}
function updateFeatureLvls(){
    window.localStorage.setItem("dispfeatlevels", JSON.stringify(dict));
    $('.displayfeaturelevelTable').empty();
    displayfeaturelevelTable();
}
function showFeatureLvls(){
    $('#importSubdiv').hide();
    $('#block_assign_row_div').hide();
    $('#dataDiv').hide();
    $('#batchmngprvbtn').hide();
    $('#dataDiv').hide();
    $('#feat_lvl_div').slideDown(500);  
    $('#dispFileFeatLvldiv').show();

}

function showBatchManagement(){
    $('#feat_lvl_div').hide();
    $('#block_assign_row_div').hide();

    $('#importSubdiv').slideDown();
    $('#batchmngprvbtn').show();
    $('#dispFileFeatLvldiv').show();

   
}
function showBlockManagement(){
    // hiding all unneccesary rows
    $('#importSubdiv').hide();
    $('#feat_lvl_div').hide();
    $('#dispFileFeatLvldiv').hide();
    $('#subj_split_batch_rowdiv').hide();
    $('#dataDiv').hide();
    $('#batchmngprvbtn').hide();
    $('#block_assign_row_div').show();
    // $('#blkoutputsDiv').show();
}
function showExpWIP(){
    $('#cr_exp_header').html("<p1>CREATE EXPERIMENT</p1>");
    $('#cr_exp_header').append("<p>"+custom_exp_id+" is UNDER CONSTRUCITON</p>");
}
$(function () {
    $("#upload").bind("click", function () {
        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.xlsx)$/;

        if (regex.test($("#fileUpload").val().toLowerCase())) {
            if (typeof (FileReader) != "undefined") {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                    console.log(e);
                    // var table = $("<table  id='showfiledataTable'/>");
                    var rows = e.target.result.split("\n");
                    console.log('rows'); 
                    console.log(typeof(rows)); 
                    var filedatalist=[]
                    /// check filedata for empty rows 
                    for (var row in rows){
                        if (rows[row]==''){
                            rows.splice(row, 1)
                        }else{
                        filedatalist.push(rows[row]);
                        }
                    }
                   setFileDataList(filedatalist);


                
                    
                    console.log('header',rows[0]);
                    header=rows[0];
                    header=header.split(',');
                    console.log('header',header[0]);
                    console.log('header',typeof(header));
                    var table=document.createElement('TABLE');
                    table.setAttribute('id','showfiledataTable')
                    table.setAttribute('class',"display table table-striped table-bordered ")    
                    var thead=document.createElement('THEAD')
                    table.appendChild(thead)
                    var tbdoy=document.createElement('TBODY');
                    table.appendChild(tbdoy);
                   
                    for (var rowindex in rows){
                     if (rowindex==0){
                        var trh=document.createElement('TR');
                        thead.appendChild(trh);
                        console.log(rows[rowindex])
                        var rowcols=rows[rowindex].split(',')
                        for (var j=0;j<rowcols.length;j++){
                            var th=document.createElement('TH');
                            th.append(rowcols[j])
                            trh.appendChild(th)
                            
                            }
                     }
                     else{
                        var tr=document.createElement('TR');
                        tbdoy.appendChild(tr);
                     
                        console.log(rows[rowindex])
                        var rowcols=rows[rowindex].split(',')
                        for (var j=0;j<rowcols.length;j++){
                            var td=document.createElement('TD');
                            td.append(rowcols[j])
                            tr.appendChild(td)
                            
                            }
                     } 
                    }
                    console.log(table)
                     $(table).appendTo("#showfiledatadiv");
                     $('#showfiledataTable').DataTable({
                           
                            "bLengthChange": false,
                            "bFilter": false,
                            "pageLength": 5,
                            "pagingType": "full_numbers"
                            });
                            $('#dataDiv').show();
                    // $('#dispFileFeatLvldiv').show();

                    // for (var i = 0; i < rows.length; i++) {
                       
                    //     console.log(rows[i]);
                    //     filedatalist.push(rows[i]);
 
                        
                    //     // var row = $("<tr />");
                    //     // var cells = rows[i].split(",");
                    //     // for (var j = 0; j < cells.length; j++) {
                    //     //     var cell = $("<td />");
                    //     //     cell.html(cells[j]);
                    //     //     row.append(cell);
                    //     // }
                    //     //  table.append(row);
                    //      console.log($(this))
                         
                    // }
                        $('#upload').prop('disabled',true);
                          
                        // var table = makeTable(filedatalist,"showfiledataTable");
                        // transposeTable(table)
                        
                       
                        //$('#showfiledatadiv').html('');
                        //$('#showfiledatadiv').append(table);
                        
                      

  
                        var select_tag1 = $('<select id="s1"/>');
                        $('<option />', {value: "", text:"None"}).appendTo(select_tag1);
                        for(var col in header) {

                            $('<option />', {value: col, text: header[col]}).appendTo(select_tag1);
                        }
                        //DEFAULT FOR TESTING
                        select_tag1.val('0');
                        var select_tag2 = $('<select id="s2" />');
                        $('<option />', {value: "", text:"None"}).appendTo(select_tag2);
                        for(var col in header) {
                            $('<option />', {value: col, text: header[col]}).appendTo(select_tag2);
                        }
                        var select_tag3 = $('<select id="s3" onchange="onS3Select(this)"/>');
                        $('<option />', {value: "", text:"None"}).appendTo(select_tag3);
                        for(var col in header) {
                            $('<option />', {value: col, text: header[col]}).appendTo(select_tag3);
                        }
                        //DEFAULT FOR TESTING
                        select_tag3.val('1');
                        $('#show_s1').append(select_tag1);
                        $('#show_s2').append(select_tag2);
                        $('#show_s3').append(select_tag3);
                        var proceedbtn= document.createElement("BUTTON");
                        var proceedStr="Process Import"
                        var text = document.createTextNode(proceedStr);
                        proceedText = proceedbtn.appendChild(text)
                        proceedbtn.onclick = function() {postExpData()};
                       // proceedbtn.classList.add("");

                        $('#proceedbtndiv').append(proceedbtn)
                        $('.map_select_label').show();
                        $('.show_select_tag').show();
                       //$('.show_select_tag').html('');
                       //$('.show_select_tag').append(select_tag);
                       
                    // for (var i = 0; i < header.length; i++) {
                    //     var radioBtn = $('<input type="radio" name="'+header[i]+'" value="'+header[i]+'"\
                    //      onclick=radioBtnFunc($(this).attr("value"),'+JSON.stringify(arrlist)+')>'+header[i]+'</input>');
                    //     //radioBtn.appendTo('#RadioDiv');

                    //     $("#RadioDiv").append(radioBtn);

                    // }

// 
//                      console.log("arr",arrlist);
//                      console.log("arr",typeof(arrlist)); 

                    
                     
                     
                     

   
                }
                reader.readAsText($("#fileUpload")[0].files[0]);
            }
             else {
                alert("This browser does not support HTML5.");
            }
        } 
        else {
            alert("Please upload a valid CSV file.");
        }
    });
});    



function onS3Select(select) {
     //alert(select.options[select.selectedIndex].text);
     if (select.options[select.selectedIndex].text==='None'){
        $('#selfbtnid').prop('disabled',false);
     }
     else{
        $('#selfbtnid').prop('disabled',true);
        $('#selfbuttondiv').empty();
        $('#self-defined').hide( 1000 );
        $('#batchtitle_name').empty();
        $('#batchtitle_input').empty();
        $('#batchnum_name').empty();
        $('#batchnum_input').empty();
        $('#batchlabel_name').empty();
        $('#batchlabel_input').empty();
        $('#self-assignbuttondiv').empty();
     }
}
function assignToBlocks(){
    $('#blocksBreakUpDiv').html(
        "<font color=red><b><i>Please wait while the assignment is being processed</i></b></font>")
    $.ajax({
        type: 'POST',
        dataType: "json",
        'data': {
            'csrfmiddlewaretoken': '{{ csrf_token }}',
        },
        // the ajax call is sent to subdetails url name in the post function.  
        url: "{% url 'assign_blocks' %}",
        success: function(data){
            console.log("<<---RECEIVED ASSIGN TO BLOCK POST RETURN--->>");
            console.log(data)
            // for(var i in data){
            //     console.log("data:",i,data[i]);
            // }
            var blocks=JSON.parse(data['blocks']);
            var batch_size_summary=document.getElementById('blocks_table');
            var batch_size_summary_thead=batch_size_summary.tHead;
            var batch_size_summary_thead_row=batch_size_summary_thead.rows[0];
            console.log('head row',batch_size_summary_thead_row);
            // batch_size_summary_thead.appendChild(th);
            // th.append('A');
            console.log(batch_size_summary.tHead.innerHTML);
            console.log(batch_size_summary.tBodies[0].rows.length)
            var batch_size_summary_tbody=batch_size_summary.tBodies[0];
            var   batch_size_summary_tbody_row_length=  batch_size_summary.tBodies[0].rows.length;
            const keys = Object.keys(blocks)
            console.log(keys);
            console.log(batch_size_summary_tbody_row_length);
           
             var col_list=[]; 
             for (var i=0;i<batch_size_summary_tbody_row_length;i++)
             {
                 console.log('i',batch_size_summary.tBodies[0].rows[i].innerHTML);
                 var tr=batch_size_summary.tBodies[0].rows[i];
                 console.log(i);
                 console.log(keys[i])
                 key=keys[i];
                 for (var  j in blocks[key]){
                                if (col_list.includes(j)) {
                                console.log('Do  nothing')
                                }
                                else{
                                col_list.push(j);
                                var th_cell=batch_size_summary_thead_row.insertCell(-1);
                                th_cell.innerHTML=j;

                                }
                    var td_cell= tr.insertCell(-1);
                    td_cell.innerHTML=blocks[key][j]
                    console.log(blocks[key][j]);
                 }

            }
            
            var newRow   = batch_size_summary_tbody.insertRow(batch_size_summary_tbody_row_length);
            var newCell  = newRow.insertCell(0);
            newCell.innerHTML='';
            var newCell  = newRow.insertCell(1);
            newCell.innerHTML='Batch Totals';
            for (var cells in blocks['Total']){
                var newCell  = newRow.insertCell(-1);
                 newCell.innerHTML= blocks['Total'][cells];
            }
            $('#blocksBreakUpDiv').html(batch_size_summary)
            // for (var row_num  in blocks){
            //     console.log('row_num',row_num);
            //     // th.append(col_name);
            //     var tr
            //     console.log('blocks[row_num]',blocks[row_num]);
            //     for (var col_name in blocks[row_num]){
                   
            //         console.log('col_name',col_name)
            //         if (col_list.includes(col_name)){
                        
            //         }
            //         else{
            //             col_list.push(col_name);
            //             th.append(col_name);
            //         }
            //         console.log('blocks[col_name][row]',blocks[col_name][row]);
            //     }
            // }
            // $('#blocksBreakUpDiv').html(data['blocks'])

            if(data['blocks']!=="Empty"){
                alert('TODO@MUDABIR: MERGE INTO ONE TABLE')
                 
            } else {
                alert('PLEASE IMPORT SUBJECTS FIRST')
            }
        }
                     
    }); 
}
var proceedbtncount=0
function postExpData(){
    var custom_id=$('#s1').children('option:selected').text();
    var email=$('#s2').children('option:selected').text() ;
    var batch_field=$('#s3').children('option:selected').text();
   
    if (batch_field=='None'){
        var selfbutton= document.createElement("BUTTON");
        var text = document.createTextNode("Self Defined ");
        selfbutton.appendChild(text)
        selfbutton.onclick = function() {switchVisible($('#self-defined'),header)};
        selfbutton.classList.add("barbutton");
        selfbutton.id='selfbtnid'
        $('#selfbuttondiv').append(selfbutton).slideDown(1000).fadeIn(1000);
    }
    else{
    var filedat=getFileDataList();
    console.log();
    if (proceedbtncount!==0){
        filedat.pop();
        filedat.pop();
        filedat.pop();
    }
    filedat.push(custom_id);
    filedat.push(email);
    filedat.push(batch_field);    
    proceedbtncount++;
    $.ajax({
                    type: 'POST',
                    dataType: "json",
                    'data': {
                    'csvfiledata': JSON.stringify(filedat),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    // the ajax call is sent to subdetails url name in the post function.  
                    // HAVE TO REMOVE IT LATER   
                    // >>url: "{% url 'postexp' %}",
                    url: "{% url 'import_subjects' %}",
                    success: function(data){
                        console.log("<<---SUBJECT IMPORT POST WAS GREAT!--->>");
                        console.log(data)
                        for(var i in data){
                            console.log("data:",i,data[i]);
                        }
                        if(exp_id===""){
                            exp_id=data['exp_id'];
                            custom_exp_id=data['custom_exp_id'];
                            showExpWIP();
                        }
                       groups=data['batches']; 
                       
                       var batch_size_table=document.createElement('TABLE'); 
                       batch_size_table.setAttribute('id','batch_size_summary')
                       batch_size_table.setAttribute('class','table table-striped table-bordered ') 
                       var b_thead=document.createElement('THEAD');
                       batch_size_table.appendChild(b_thead);
                       var b_tbdoy=document.createElement('TBODY');
                       batch_size_table.appendChild(b_tbdoy);
                       var trh=document.createElement('TR');
                       b_thead.appendChild(trh);
                       var th=document.createElement('TH');
                       trh.appendChild(th);
                       th.append('Index');
                       var th=document.createElement('TH');
                       th.append('Batch Size');
                       trh.appendChild(th);
                       var total=0;
                       for (var rowindex in groups){
                           var tr=document.createElement('TR');
                           b_tbdoy.appendChild(tr);
                           var td=document.createElement('TD');
                           console.log('rowindex',rowindex);
                           td.append(rowindex);
                           tr.appendChild(td);
                           var td=document.createElement('TD')
                           console.log('groups[rowindex]',groups[rowindex])
                           td.append(groups[rowindex]);
                           tr.appendChild(td);
                           var num=parseInt(groups[rowindex])
                           total=total+num;
                       }
                           var tr=document.createElement('TR');
                           b_tbdoy.appendChild(tr);
                           var td=document.createElement('TD');
                           td.append('Total');

                           tr.appendChild(td);
                           var td=document.createElement('TD');
                           td.append(total);
                           tr.appendChild(td);
                       console.log(batch_size_table);
                      $(batch_size_table).appendTo('.batchsize_div')    
                        // if(data['batches']!==""){
                        //     var tab_batches = $("<table id=\'tab_batch\'/>");
                        //     var head_row = $("<tr />");
                        //     var head_sno_col = $("<th />");
                        //     head_sno_col.html("Batches")
                        //     head_row.append(head_sno_col)
                        //     var head_lset_col = $("<th />");
                        //     head_lset_col.html("Subject Count")
                        //     head_row.append(head_lset_col)
                        //     tab_batches.append(head_row)
                        //     var totCount = 0;
                        //     for(var j in data['batches']){
                        //         var btch_row = $("<tr />");
                        //         var btch_cell = $("<td />");
                        //         btch_cell.html(j);
                        //         btch_row.append(btch_cell);
                        //         var count_cell = $("<td />");
                        //         var btch_count = data['batches'][j];
                        //         count_cell.html(btch_count);
                        //         totCount += btch_count;
                        //         btch_row.append(count_cell);
                        //         tab_batches.append(btch_row)
                        //     }
                        //     total_row = $("<tr />");
                        //     total_label = $("<td />");
                        //     total_label.html('Total');
                        //     total_row.append(total_label);
                        //     total_cell = $("<td />");
                        //     total_cell.html(totCount);
                        //     total_row.append(total_cell);
                        //     tab_batches.append(total_row);
                        //     $('.batchsize_div').html('');
                        //     $('.batchsize_div').append(tab_batches);
                        // }
                    }
                     
                    }); 
    }
    
    
        
                   
    
    
}
function selfpreDivOpt(){
    
    
    
    // if ((sel3=='')){
        

                        

    //     var selfbutton= document.createElement("BUTTON");
    //     var text = document.createTextNode("Self Defined ");
    //     selfbutton.appendChild(text)
    //     selfbutton.onclick = function() {switchVisible($('#self-defined'),header)};
    //     selfbutton.classList.add("barbutton");
    //     $('#selfbuttondiv').append(selfbutton).slideDown(1000).fadeIn(1000);
    
    // }
    // else{
    //     var prebutton= document.createElement("BUTTON");
    //     var text = document.createTextNode("PreDefined");
    //     prebutton.appendChild(text)

    //     prebutton.onclick = function() {switchVisible($('#pre-defined'),header)};
    //     prebutton.classList.add("barbutton");
    //     $('#predefbuttondiv').append(prebutton).slideDown(1000).fadeIn(1000);
    // }

}
// Switch Function to show and hide self and pre defined divs. 
function switchVisible(obj,header) {
    if (obj) {
        console.log("swvob",obj);
        console.log('header',header)
        console.log('id',obj.is("#self-defined") )
        if (obj.attr("id") === "self-defined" &&  obj.is(":hidden")) {
            console.log("in if");
            var batchtitlename=$('<label>Batch Name:</label>');
            var batchtitleinput = $('<input class="crtinput" type="text" name="batchtitle" value="Batch" placeholder="Batch" id="selfbatchtitleid">');
            var batchnumname=$('<label>Num of Batches:</label>');
            var batchnuminput = $('<input type="text" class="crtinput" name="batchnum" value="2" placeholder="2"  id="selfbatchnumid" >');
            var batchlabelname=$('<label>Label Batches:</label>');
            var batchlabelinput = $('<input type="text" class="crtinput" name="batchlabel"  id="selfbatchlabelid" >');
            var selfassignbutton= $('<button id="selfassignbutton"onclick=selfAssignBatch()>Make Batch</button>') ;
            
            $('#batchtitle_name').append(batchtitlename);
            $('#batchtitle_input').append(batchtitleinput);
            $('#batchnum_name').append(batchnumname);
            $('#batchnum_input').append(batchnuminput);
            $('#batchlabel_name').append(batchlabelname);
            $('#batchlabel_input').append(batchlabelinput);
            $('[name=batchlabel]').val('1,2');
            $('#self-assignbuttondiv').append(selfassignbutton);

            

        
            $('#self-defined').toggle(1000);

           // document.getElementById('self-defined').style.display = 'block';
            $('#pre-defined').hide( 1000 );
            $('#pre-batchtitletext').empty();
            $('#pre-RadioDiv').empty();
            $('#pre-assignbuttondiv').empty();

            
            //document.getElementById('pre-defined').style.display = 'none';
        }
        else if (obj.attr("id") === "self-defined" &&  obj.is(":visible")){
            $('#self-defined').hide( 1000 );
            $('#batchtitle_name').empty();
            $('#batchtitle_input').empty();
            $('#batchnum_name').empty();
            $('#batchnum_input').empty();
            $('#batchlabel_name').empty();
            $('#batchlabel_input').empty();
            $('#self-assignbuttondiv').empty();
        }
        else if (obj.attr("id") === "pre-defined" &&  obj.is(":hidden")) {
            
        //    // $('[name=batchlabel]').remove();
        //    $('#self-defined').hide( 1000 );
        //     $('#batchtitle_name').empty();
        //     $('#batchtitle_input').empty();
        //     $('#batchnum_name').empty();
        //     $('#batchnum_input').empty();
        //     $('#batchlabel_name').empty();
        //     $('#batchlabel_input').empty();
        //     $('#self-assignbuttondiv').empty();


        //    // In future delete this block of code. @TODO
        // //    var batchtitle=$('<p>Select one of the Fields for Batch Assigning</p>');
        // //    $('pre-batchtitletext').append(batchtitle);
        // //    for (var i = 0; i < header.length; i++) {
        // //             var radioBtn = $('<input type="radio" name="'+header[i]+'" value="'+header[i]+'"\
        // //             onclick="radioBtnFunc($(this))"\
        // //             >'+header[i]+'</input>');
        // //             //radioBtn.appendTo('#RadioDiv');

        // //             $("#pre-RadioDiv").append(radioBtn);

        // //         }
        //     var sel1T=$('#s1').children('option:selected').text();
        //     var sel2T=$('#s2').children('option:selected').text();
        //     var sel3T=$('#s3').children('option:selected').text();
        //     $('#custom_label_id1').append('Customid');
        //     $('#custom_label_id1').append('-->');
        //     $('#custom_tag_id1').append(sel1T);
        //     $('#email_label_id1').append('Email');
        //     $('#email_label_id1').append('-->');
        //     $('#email_tag_id1').append(sel2T);
        //     $('#batchT_label_id1').append('Batch Title');
        //     $('#batchT_label_id1').append('-->');
        //     $('#batchT_tag_id1').append(sel3T);
            
        //     var assignbutton= $('<button onclick=preAssignBatch('+JSON.stringify(sel1T)+','+JSON.stringify(sel2T)+','+JSON.stringify(sel3T)+')>Make Batch</button>') ;
        //     assignbutton.fadeIn(300);
        //     $('#pre-assignbuttondiv' ).append(assignbutton) ;
        //     $('#pre-defined').show(1000);
        //    // document.getElementById('pre-defined').style.display = 'block';
             }   
    }
}
//  
function selfAssignBatch(){
    var filedata=getFileDataList();
    // filedata.pop();
    // filedata.pop();
    // filedata.pop();
    var custom_id=$('#s1').children('option:selected').text();
    var email=$('#s2').children('option:selected').text() ;
    var batch_field=$('#s3').children('option:selected').text();
    console.log('filedata',filedata);
    var fieldname=$('#selfbatchtitleid').val();
    console.log('fieldname',fieldname);
    var fieldnum=$('#selfbatchnumid').val();
    console.log('fieldnum',fieldnum);
    var fieldlabel=$('#selfbatchlabelid').val();
    console.log('fieldlabel',fieldlabel);
    console.log(typeof(fieldlabel));
    var assigntype='self';
    filedata.push(custom_id);
    filedata.push(email);
    filedata.push(batch_field);

    
    
    filedata.push(fieldname);
    filedata.push(fieldnum);
    filedata.push(fieldlabel);


    filedata.push(assigntype);
    console.log('fileDATA',filedata);
    refreshFileDataList();
    $.ajax({
                    type: 'POST',
                    dataType: "json",
                    'data': {
                    'csvfiledata': JSON.stringify(filedata),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    // the ajax call is sent to subdetails url name in the post function.  
                    url: "{% url 'uploadsamplefile' %}",
                    success: function(data){
                        if(exp_id===""){
                            exp_id=data['exp_id'];
                            custom_exp_id=data['custom_exp_id'];
                            showExpWIP();
                        }
                        console.log(JSON.parse(data[1]))
                        dataframe_table=JSON.parse(data[1])
                        var mydata = dataframe_table;
                        var table = makeTable(mydata,"mytable");
                        transposeTable(table)
                        
                        $(table).appendTo("#subj_split_batch");
                        $('#mytable').DataTable({
                           
                            "bLengthChange": false,
                            "bFilter": false,
                            "pageLength": 5
                            });
                        // hiding the csv file data.
                        $('#dataDiv').hide();
                        $('#subj_split_batch_rowdiv').show();

                        groups=JSON.parse(data['batches']); 
                       
                        var batch_size_table=document.createElement('TABLE'); 
                        batch_size_table.setAttribute('id','batch_size_summary')
                        batch_size_table.setAttribute('class','table table-striped table-bordered ') 
                        var b_thead=document.createElement('THEAD');
                        batch_size_table.appendChild(b_thead);
                        var b_tbdoy=document.createElement('TBODY');
                        batch_size_table.appendChild(b_tbdoy);
                        var trh=document.createElement('TR');
                        b_thead.appendChild(trh);
                        var th=document.createElement('TH');
                        trh.appendChild(th);
                        th.append('Index');
                        var th=document.createElement('TH');
                        th.append('Batch Size');
                        trh.appendChild(th);
                        var total=0;
                        for (var rowindex in groups){
                            var tr=document.createElement('TR');
                            b_tbdoy.appendChild(tr);
                            var td=document.createElement('TD');
                            console.log('rowindex',rowindex);
                            td.append(rowindex);
                            tr.appendChild(td);
                            var td=document.createElement('TD')
                            console.log('groups[rowindex]',groups[rowindex])
                            td.append(groups[rowindex]);
                            tr.appendChild(td);
                            var num=parseInt(groups[rowindex])
                            total=total+num;
                        }
                            var tr=document.createElement('TR');
                            b_tbdoy.appendChild(tr);
                            var td=document.createElement('TD');
                            td.append('Total');

                            tr.appendChild(td);
                            var td=document.createElement('TD');
                            td.append(total);
                            tr.appendChild(td);
                        console.log(batch_size_table);
                       $(batch_size_table).appendTo('.batchsize_div')    
                       }
                    }); 
    


}
//  
function radioBtnFunc(radiovalue){
        console.log('radiovalue',radiovalue.attr('value')) ;
        var radioinput_value=radiovalue.attr('value'); 
        var assignbutton= $('<button onclick=preAssignBatch('+JSON.stringify(radioinput_value)+')>Make Batch And assign to blocks</button>') ;
                         assignbutton.fadeIn(300);
                         $('#pre-assignbuttondiv' ).append(assignbutton) ;
    
}

function preAssignBatch(sel1T,sel2T,sel3T){
    var filedata=getFileDataList();
    console.log(filedata);
    // var fieldname=radioinput_value;
    // console.log("fieldname",fieldname);
    
    console.log(filedata);
    filedata.push(sel1T);
    filedata.push(sel2T);
    filedata.push(sel3T);
    filedata.push('pre');
    console.log(filedata);
    refreshFileDataList();
    $.ajax({
                    type: 'POST',
                    dataType: "json",
                    'data': {
                    'csvfiledata': JSON.stringify(filedata),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    // the ajax call is sent to subdetails url name in the post function.  
                    url: "{% url 'uploadsamplefile' %}",
                    success: function(data){
                      
                       //create table
                        
                        //  for (var i in data){// 
                        //     // row 
                             
                        //      console.log(i); // key RollNO  Individual cells. 
                        //      // add all to the row.    
                        //      console.log(Object.values(data[i]).length);  // Value {0: 1239123}
                        //      for (var j in data[i] ){  
                        //          console.log(data[i][j]);
                        //      }
                        //  }
                        
                        var mydata = eval(data);
                        var table = makeTable(mydata);
                        transposeTable(table)
                        $(table).appendTo("#subj_split_batch");
                      
                
                       }
                     
                    }); 
    
}

function makeTable (mydata,tableid) {
    
    var table = $('<table  id='+tableid+' class="table table-bordred table-striped">');
    var thead = $('<thead>');

    var tblHeader = "<tr>";
        
    for (var k in mydata) tblHeader += "<th>" + k + "</th>";

    tblHeader += "</tr>";
    $(tblHeader).appendTo(thead);
    $(thead).appendTo(table)
    
    var tbody = $('<tbody>');
   

    $.each(mydata, function (index, value) {
        var TableRow = "<tr>";
                
        $.each(value, function (key, val) {
            TableRow += "<td>" + val + "</td>";
    
        });
        TableRow += "</tr>";
        $(TableRow).appendTo(tbody);
        // $(table).append(TableRow);
        

    });

    $(tbody).appendTo(table);
    return ($(table));
};

function transposeTable(table) {
        var $this = table.children('tbody');
        var newrows = [];
        $this.find("tr").each(function(){
            var i = 0;
            $(this).find("td").each(function(){
                i++;
                if(newrows[i] === undefined) { newrows[i] = $("<tr></tr>"); }
                newrows[i].append($(this));
            });
        });
        $this.find("tr").remove();
        $.each(newrows, function(){
            $this.append(this);
        });
  
}

function setFileDataList(filedatalist){
    globalfiledatalist=filedatalist
}
function emptyFileDataList(){
  globalfiledatalist=[];
}
function getFileDataList(){
    return globalfiledatalist;
   
}
function refreshFileDataList (){
  var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;

if (regex.test($("#fileUpload").val().toLowerCase())) {
    if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.onload = function (e) {
          
            var rows = e.target.result.split("\n");
            var filedatalist=[];

            for (var i = 0; i < rows.length; i++) {
               
                console.log(rows[i]);
                filedatalist.push(rows[i]);

            }
            
            setFileDataList(filedatalist);
            

        }
        reader.readAsText($("#fileUpload")[0].files[0]);
    }
     else {
        alert("This browser does not support HTML5.");
    }
} 
else {
    alert("Please upload a valid CSV file.");
}
}
function chooseFileFunc(){
  $('#upload').prop('disabled',false);
}

// Outercheckbox function 
// This function gets 2 arguments when called val and id attribute of input type=checkbox
// having id based on the feature.id.
// It is called through onclick function. 
function outerCheckBox(outercheckval,outercheckid) {
console.log("checkbox");
console.log(outercheckval);
console.log(outercheckid);
// Ajax call is made to send the outercheckboxid to the controller. 
// The controller will fetch the sub-details of that feature from model and return back in
// in success function. 
// Success funtion will first check if the outercheckbox is checked or unchecked. 
// If unchecked it'll simply hide the innercheckboxdiv or do nothing as by default its hidden.
// else will populate data in that div and show to user.  
$.ajax({
type: 'POST',
dataType: "json",
'data': {
'd': JSON.stringify(outercheckval),
'csrfmiddlewaretoken': '{{ csrf_token }}',
},
// the ajax call is sent to subdetails url name in the post function.  
url: "{% url 'subdetails' %}",
success: function(data){
console.log("success");
var outerckbox = $('#'+outercheckid);
console.log('outercheckbox obj',outerckbox);
dict[outercheckval]=data
console.log('value of key in dic',dict[outercheckval]);
// checking if the user has checked or not. 

if (outerckbox.is(':checked')) {
    // alert('You Checked');
    console.log('outercheckval',outercheckval);
    console.log('data retrieved',data)
    dict[outercheckval]=data
    if (data==null){
        dict[outercheckval]=[0,1]
    }
    console.log('dictionary',dict)
    // calling innercheckboxdivs. 
    // these divs basically come after outercheckbox that contain innerchecks.
    // outercheck id and the data is sent to this function.
    // This function shows the innerChecksdivs after including and populating data in 
    // innerchecks.
    // todo: change the name of innercheckboxdivs name as it seems like it is refering to
    // div inside inner checks...
    
    // checkbox_id_dict[outercheckid]=[];
    showInnerCheckBoxDivs(outercheckid,data);
    updateFeatureLvls();
} else {
    // alert('You Un-Checked it');
    // For now its purpose is simply to hide the innercheckdivs.  
    hideInnerCheckBoxDivs(outercheckid);
    console.log(outercheckval);
    dict[outercheckval]=null;
    if (dict[outercheckval]==null  ){
        delete dict[outercheckval];
        console.log('in else condition');  
    }
    var get_dict=JSON.parse(window.localStorage.getItem("feat_dict")); 
    get_dict=dict;
    var set_dict=get_dict;
    window.localStorage.setItem("feat_dict", JSON.stringify(set_dict));

    console.log(dict)
    updateFeatureLvls();
}
}
}); 
}

// once the onclick function=>(innercheckbox) of inner checks are called it 
// shows three things. innercheck value , id and outer check value/title.
function innerCheckBox(innercheckval,innercheckid,outercheckdivtitle,outercheckdivid){
//console.log(innercheckval,innercheckid,outercheckdivtitle);

console.log('outercheckbox title',outercheckdivtitle)
var innercheckboxid = $('#'+innercheckid);
//var parentdiv=innercheckboxid.parent();
//var parentdivid=parentdiv.attr('id');
var temparr=outercheckdivid.split('-');
console.log('outercheck id ',temparr[0])
var innercheckboxid_elem = document.getElementById(innercheckboxid);

//console.log("outerchekboxid-",outercheckid );
console.log("innercheckbox-",innercheckboxid );
// checking if the user has checked or not. 

// if ($(innercheckboxid).is(':checked')) {
    console.log('#'+temparr[0])
    // $('#'+temparr[0]).prop('checked',true);
    
if ($(innercheckboxid).prop('checked') == true){
    //Process for adding the innercheck value in dict. 
            if (dict[outercheckdivtitle] == null) {
                    dict[outercheckdivtitle]=[]
                }   
            arr_feature_levels=dict[outercheckdivtitle];
            console.log('Specific dict in Checked',dict[outercheckdivtitle]);
            console.log('insert',arr_feature_levels);
            arr_feature_levels.push(innercheckval);
            dict[outercheckdivtitle]=arr_feature_levels;
            console.log('arr',arr_feature_levels);
            console.log('All dict in checked condition.',dict);
            // updating feat_dict in session. 
            var get_dict=JSON.parse(window.localStorage.getItem("feat_dict")); 
            get_dict=dict;
            var set_dict=get_dict;
            window.localStorage.setItem("feat_dict", JSON.stringify(set_dict));

            
            updateFeatureLvls();
    //Process for adding innercheck id in checkbox_id_dict
            // 1.GET THE OUTER CHECK BOX ID BY GETTING LAST INDEX OF INNER CHECK ID. 
            var outercheckid=innercheckid.slice(-1);
            // get all innercheck present in check_id_dict
            var innercheck_all_id=checkbox_id_dict[outercheckid];
            // push newly selected one into innercheck_All_id
            innercheck_all_id.push(innercheckid);
            //
            checkbox_id_dict[outercheckid]=innercheck_all_id;
            console.log('newly added id in check dic',checkbox_id_dict)
            // Update check_id_dict in session. 
            var get_chkbx_id_dict=JSON.parse(window.localStorage.getItem("checkbox_id_dict")); 
            var get_chkbx_id_dict=checkbox_id_dict;
            var set_chkbx_id_dict=get_chkbx_id_dict;
            window.localStorage.setItem("checkbox_id_dict", JSON.stringify(set_chkbx_id_dict));


        

        
    
} else if ($(innercheckboxid).prop('checked') == false) {
   // PROCESS TO DELETE THE UNCHECKED  FEATURE LEVEL FROM DICT 
                    // Getting all the feature levels of the feature in a list. 
                    arr_feature_levels=dict[outercheckdivtitle];
                    console.log('Specific dict in UnChecked',dict[outercheckdivtitle]);
                    console.log('arr',arr_feature_levels);
                    console.log(innercheckval);
                    var index = $.inArray(innercheckval, arr_feature_levels);
                        if (index != -1) {
                            var removedvalue=arr_feature_levels.splice(index, 1);
                            console.log('removedvalue',removedvalue);
                    
                        

                        }
                    console.log('del arr',arr_feature_levels);  
                    console.log('del arr',arr_feature_levels.length);
                    // A Check to see if all inner checks are unchecked then remove the key aswell
                    if (arr_feature_levels.length===0){
                        delete  dict[outercheckdivtitle];
                        console.log('condition check');
                        console.log('deleted dic',dict);
   
                    }
                    else{ 
                        dict[outercheckdivtitle]=arr_feature_levels;
                        console.log('dict',dict);
                        
                    }
                    // UPdate Feat_dict in session. 
                    var get_dict=JSON.parse(window.localStorage.getItem("feat_dict")); 
                    get_dict=dict;
                    var set_dict=get_dict;
                    window.localStorage.setItem("feat_dict", JSON.stringify(set_dict));

 // PROCESS TO DELETE THE UNCHECKED FEATURE LEVEL ID FROM CHECKBOX_ID_DICT 
                // 1.GET THE OUTER CHECK BOX ID BY GETTING LAST INDEX OF INNER CHECK ID. 
                var outercheckid=innercheckid.slice(-1);
                // get all the innercheck id from checkbox_id_dict of key outercheckid..
                var innercheck_all_id=checkbox_id_dict[outercheckid]
                // get the index of the innercheckid in innercheck_All_id list
                // Then remove it. 
                var innercheck_id_index = $.inArray(innercheckid, innercheck_all_id);
                                    if (innercheck_id_index != -1) {
                                        var removedid=innercheck_all_id.splice(index, 1);
                                        console.log('removedid',removedid);
                                    }
                                    console.log('innercheck_all_id list',innercheck_all_id);  
                                // A Check to see if all inner checks are unchecked then remove the key aswell
                                if (innercheck_all_id.length===0){
                                        delete  checkbox_id_dict[outercheckid];
                                        console.log('condition check');
                                        console.log('checkbox_id_dic after deletion',checkbox_id_dict);
                                        var x = document.getElementById(outercheckid);
                                        x.checked = false;
                                        $('#'+outercheckid+'-innercheckboxdiv').hide();
                                        $('#'+outercheckid+'-innercheckboxdiv').empty();
                                    }
                                else{ 
                                    checkbox_id_dict[outercheckid]=innercheck_all_id;
                                    console.log('checkbox_id_dict',checkbox_id_dict);
                                }
                                // Update check_id_dict in session. 
                                var get_chkbx_id_dict=JSON.parse(window.localStorage.getItem("checkbox_id_dict")); 
                                var get_chkbx_id_dict=checkbox_id_dict;
                                var set_chkbx_id_dict=get_chkbx_id_dict;
                                window.localStorage.setItem("checkbox_id_dict", JSON.stringify(set_chkbx_id_dict));




    }
    updateFeatureLvls();
}

function showInnerCheckBoxDivs(outercheckid,data){
console.log('#'+outercheckid+'-innercheckboxdiv')
// Creating inner checks and populating them with data. 

 var innercheckbox_id_list=[];
for (var o in data){
        console.log('A',o);    
        var innercheck_element =  $(document.createElement("input")).attr({
                id: o +'-innercheckbox-'+outercheckid,
                name:  '',
                value: data[o],
                text :'',
                type:  'checkbox',
                checked:true,
                onclick:"innerCheckBox($(this).attr('value'),$(this).attr('id'),\
                $(this).parent().attr('title'), $(this).parent().attr('id')\
                )"
            
        })
        var inner_id=innercheck_element.attr('id')
        console.log('INNERCHECK FUNC CHECK DICT',checkbox_id_dict);
        var stored_innercheckbox_id_list=checkbox_id_dict[outercheckid]
        console.log('stored_innercheckbox_id_list',stored_innercheckbox_id_list)
        if ((stored_innercheckbox_id_list===undefined )|| (stored_innercheckbox_id_list==[])){
           innercheckbox_id_list.push(inner_id);
        }
        else{
           
            // IT WILL BE ALWAYS FALSE if check_id_dict[key] is empty> IT SHOULD BE FALSE>
            for (var value_id in stored_innercheckbox_id_list){
                    console.log(stored_innercheckbox_id_list[value_id]);
                    console.log (inner_id)
                

                            if (stored_innercheckbox_id_list[value_id]===inner_id)
                            {    console.log('in if cond')
                                innercheckbox_id_list.push(inner_id)
                                

                            }
                            else{
                                console.log('in else cond')
                                innercheck_element.prop('checked',false)

                            }
                }
        }
        
       
        
             
        // adding input attributes to a div
        $('#'+outercheckid+'-innercheckboxdiv').append(innercheck_element);
        $('#'+outercheckid+'-innercheckboxdiv').append(data[o]);
        $('#'+outercheckid+'-innercheckboxdiv').show();
    }
     checkbox_id_dict[outercheckid]=innercheckbox_id_list;
    // alert(checkbox_id_dict[outercheckid]);
     console.log('DICTionary',dict);
     window.localStorage.setItem("feat_dict", JSON.stringify(dict));
     window.localStorage.setItem("checkbox_id_dict", JSON.stringify(checkbox_id_dict));
   
     console.log('All innercheck boxid added to checkbox dict',checkbox_id_dict);
}

// function that hides the divs containing innercheckbox
function hideInnerCheckBoxDivs(outercheckid){
    delete checkbox_id_dict[outercheckid];
    var get_chkbx_id_dict=JSON.parse(window.localStorage.getItem("checkbox_id_dict")); 
    var get_chkbx_id_dict=checkbox_id_dict;
    var set_chkbx_id_dict=get_chkbx_id_dict;
    window.localStorage.setItem("checkbox_id_dict", JSON.stringify(set_chkbx_id_dict));

    console.log("checkbox_id_dict",checkbox_id_dict);
$('#'+outercheckid+'-innercheckboxdiv').hide();
$('#'+outercheckid+'-innercheckboxdiv').empty();

}



function sendFeatureLevels(){
$.ajax({
type: 'POST',
dataType: "json",
'data': {
'dict': JSON.stringify(dict,undefined,''),
'exp_id': exp_id,
'csrfmiddlewaretoken': '{{ csrf_token }}',
},
// the ajax call is sent to createexp url name in the post function.  
url: "{% url 'createexp' %}",
success: function(data){
    console.log("<<---FEATURES POSTED SUCCESSFULLY--->>");
    console.log(data)
    //console.log('Blocks---> ',data);
    for(var i in data){
        console.log("Hi:",i,data[i])
      
    }
    if(exp_id===""){
        exp_id = data['exp_id'];
        custom_exp_id = data['custom_exp_id'];
        showExpWIP()
    }
        if (data['block_list']!=null){
            blockList = data['block_list']
            table_blocks=draw_block_table(blockList)
            display_blocktable(table_blocks);
            window.localStorage.setItem("blockList", JSON.stringify(blockList));
 
        }
    }
  }); 
}
function draw_block_table(blocklist){
        // var tab_blocks = $("<table id='blocks_table'/>");
       
        var table_blocks=document.createElement('TABLE');
        table_blocks.setAttribute('id','blocks_table');
        table_blocks.setAttribute('class','table table-striped table-bordered table-condensed');

        var thead=document.createElement('THEAD');
        table_blocks.appendChild(thead);
        var tbody=document.createElement('TBODY');
        table_blocks.appendChild(tbody);
        var trh=document.createElement('TR');
        thead.appendChild(trh);
        var  th=document.createElement('TH');
        trh.appendChild(th);
        th.append('Block No');
        var  th=document.createElement('TH');
        trh.appendChild(th);
        th.append('Feature Level Combination');


        // var head_row = $("<tr />");
        // var head_sno_col = $("<th />");
        // head_sno_col.html("Block No")
        // head_row.append(head_sno_col)
        // var head_lset_col = $("<th />");
        // head_lset_col.html("Feature Level Combination")
        // head_row.append(head_lset_col)
        // tab_blocks.append(head_row)
    for(var i = 0; i < blocklist.length; i++){
            var tr=document.createElement('TR')
            tbody.appendChild(tr);
            var td=document.createElement('TD')
            tr.appendChild(td);
            td.append(blocklist[i]['serial_no'])
            var td=document.createElement('TD')
            tr.appendChild(td);
            td.append(blocklist[i]['levels_set'])


        //     var blk_row = $("<tr />");
        //     var blk_no_cell = $("<td />");
        //     console.log("Block: ",blocklist[i]['serial_no'])
        //     blk_no_cell.html(blocklist[i]['serial_no']);
        //     blk_row.append(blk_no_cell);
        //     var blk_lSet_cell = $("<td />");
        //     var blk_lSet = blocklist[i]['levels_set']
        //     blk_lSet_cell.html('')
        //     for(var j = 0; j < blk_lSet.length; j++){
        //         blk_lSet_cell.append(blk_lSet[j])
        //         if(j!=(blk_lSet.length-1)){
        //             blk_lSet_cell.append(", ")
        //         }
        //     }
        //             blk_row.append(blk_lSet_cell);
        //             tab_blocks.append(blk_row);
         }
    return table_blocks;
}
function display_blocktable(table_blocks){
    // Is not useed anymore
    // $('#blocksBreakUp').html('');
    // $('#blocksBreakUp').append(table_blocks);
    $('#generated_blocks').html('');
    $('#generated_blocks').append(table_blocks);
    
}

function sendFilePath(id){
        console.log(id);
        console.log($('#'+id).val().replace(/C:\\fakepath\\/i, ''));
        var filepath=$('#'+id).val().replace(/C:\\fakepath\\/i, '');
        console.log(filepath);
        $.ajax({
        type: 'POST',
        dataType: "json",
        'data': {
        'dict': JSON.stringify(filepath),
        'csrfmiddlewaretoken': '{{ csrf_token }}',
        },
        // the ajax call is sent to subdetails url name in the post function.  
        url: "{% url 'createexp' %}",
        success: function(data){}
        
        }); 

      }
</script>
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>


<script src="{% static 'webapp/createexp/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js' %}"></script>
<link rel="stylesheet" type="text/css" src="{% static 'webapp/createexp/DataTables/DataTables-1.10.18/cs/jquery.dataTables.min.css' %}"/>
<script>
    // Warning before leaving the page (back button, or outgoinglink)
    window.onbeforeunload = function() {
       return "Do you really want to leave our brilliant application?";
       //if we return nothing here (just calling return;) then there will be no pop-up question at all
       //return;
    };
   
</script>
{%endblock%}