{% extends "webapp/crudexperiment/base_experiment.html" %}
{% block content %}
{%load static from staticfiles%}
<style>
table {
    vertical-align: center;
    border: 1px solid black;
}
th, td {
    border: 1px solid black;
}
</style>
<div class="container-fluid text-center">    
      <div class="row content">
          <div class="col-sm-2 sidenav" style='background:teal'></div>
          <div class="col-sm-9  col-md-9 col-lg-9 col-xs-9 text-left" > 
                  
            <div class ="row-fluid">     
                      <div class ="row">   
                            <div class='col-md-12' id="cr_exp_header" >
                            <p1>Create Experiment </p1> <!-- Show Experiment Id here e.g. ses-007 (admin id) + experiment no. (5 digits)-->
                            </div>  
                        </div>
                      <div class ="row"> 
                          <div class='col-md-12' >    
                            <!-- <p1>Admin id {{admin_id}}</p1> -->
                          </div>                            
                      </div>
                      <div class ="row"> 
                          <div class='col-md-12' >    
                            <!-- <p1>Experiment id {{experiment_id}}</p1> -->
                          </div>                            
                      </div>
            </div>
            <div class='row-fluid'>
                <div class='row'>
                <div class='col-md-4'><button onclick='showFeatureLvls()'>Feature Levels</button> </div>
                <div class='col-md-4'><button onclick='showBatchManagement()'>Batch Management</button></div>
                <div class='col-md-4'><button>Block Management</button></div>
                </div>    
            </div>
            <div class='row-fluid'>
                <div class='row'>
                    <div class="col-md-6" id='feat_lvl_div'>
                    <div class='row-fluid' style="background:peru;">
                        {% for feature in platformfeatobj%}
                        <div class='row-fluid'>
                        <div class='col-md-12'>
                            <input type="checkbox"  id='{{feature.id}}' action='{%url "createexp"%}'
                                    method="post" 
                                    value="{{feature.feature_symbol}}" 
                                    onclick="outerCheckBox($(this).attr('value'),$(this).attr('id'))">
                                    {{feature.feature_name}} 
                                    <div  id='{{feature.id}}-innercheckboxdiv' class='innerchecksboxdivs' title='{{feature.feature_symbol}}'>
                                    </div>
                            </input>
                            <br>
                        </div>
                        </div>
                        {%endfor%}
                </div>
                <div class='row-fluid'>
                    <button onclick='sendFeatureLevels()'> Set Feature Levels </button>
                    <button onclick='showImportSubdiv()'>NEXT</button>
                </div>  
                    </div>
                    <div class='col-md-6'  style='background:palegoldenrod'
                        id='outputsDiv'>
                        <div id='blocksBreakUp'><b>TESTING 123</b></div>
                    </div>
                </div>  
            <br>
            </div>
            <div class='row-fluid' style="background: cadetblue" id='importSubdiv'> 
                    <div class='row'>
                      <div class='col-md-5'>
                
                          <div class=row-fluid>
                              <label>Import Subjects</label>
                               <br>
                              <input type="file"  id="fileUpload" onclick="chooseFileFunc()"/>
                          <input type="button" id="upload" value="Upload" />
                          </div>
                          <hr />
                          <div class='row-fluid'>
                                <div class='col-md-12'  >
                                        <div class='row'>
                                                <div class='col-md-6' style='background:lightgreen'><div class='map_select_label' id='custom_label_id'>Custom id</div> </div>
                                                <div class='col-md-6'style='background: orange'> <div class="show_select_tag" id="show_s1"></div></div>
                                        </div>
                                    </div>
                                    <div class='col-md-12' >
                                            <div class='row'>
                                                    <div class='col-md-6' style='background: lightgreen'> <div class='map_select_label' id='email_label_id'>Email</div></div>
                                                    <div class='col-md-6'style='background: orange'> <div class="show_select_tag" id="show_s2"></div></div>
                                            </div>
                                    </div>
                                    <div class='col-md-12' >
                                            <div class='row'>
                                                    <div class='col-md-6' style='background: lightgreen'> <div class='map_select_label' id='batchT_label_id'>Batch Title</div></div>
                                                    <div class='col-md-6'style='background: orange'> <div class="show_select_tag" id="show_s3"></div></div>
                                            </div>
                                    </div>
                                    <div class='col-md-12' >
                                        <div class='row'>
                                                <div class='col-md-6' > </div>
                                                <div class='col-md-6'style='background:pink'> <div id='proceedbtndiv'></div></div>
                                        </div>
                                </div>
                                <div class='col-md-12' >
                                        <div class='row'>
                                                
                                                <div class='col-md-12'>  <div id="showfiledata"></div></div>
                                        </div>
                                </div>
                                   
                                   
                          </div>
                          
                          <div class='row-fluid' >
                               
                                        <div class='row-fluid' >
                                                <div class='col-md-12' id='selfbuttondiv'>
                                                
                                                </div>
                                        </div>
                                     
                              
                                 <div class='row-fluid' >
                                    <div class='col-md-12'  id='self-defined'>
                                         <hr/>
                                         
                                         <div class='row'>
                                             <div class='col-md-6' id='batchtitle_name'></div>
                                             <div class='col-md-6' id='batchtitle_input'></div>

                                         </div>
                                         <div class='row'>
                                                <div class='col-md-6' id='batchnum_name'></div>
                                                <div class='col-md-6' id='batchnum_input'></div>

                                         </div>
                                         
                                         <div class='row'>
                                                <div class='col-md-6' id='batchlabel_name'></div>
                                                <div class='col-md-6' id='batchlabel_input'></div>

                                         </div>
                                        <div class='row'>
                                            <div class='col-md-6' ></div>
                                            <div class='col-md-6' id='self-assignbuttondiv'></div>
                                       
                                        </div>

                                    </div>
                                 </div>
                          </div>
                          <div class='row-fluid'>
                                    <div class='row-fluid' >
                                        <div class='col-md-12' id='predefbuttondiv'>
                                            
                                        </div>
                                    </div>

                            <div class='row-fluid' >

                                <div class='col-md-12' id='pre-defined'> 
                                    <hr/>
                                    <div class='row'>
                                            <div class='col-md-6'><div id='custom_label_id1'></div></div>
                                            <div class='col-md-6'><div id='custom_tag_id1'></div></div>
                                    </div>
                                    <div class='row'>
                                            <div class='col-md-6'><div id='email_label_id1'></div></div>
                                            <div class='col-md-6'><div id='email_tag_id1'></div></div>
                                    </div>
                                    <div class='row'>
                                            <div class='col-md-6'><div id='batchT_label_id1'></div></div>
                                            <div class='col-md-6'><div id='batchT_tag_id1'></div></div>
                                    </div>
                                    <!-- <div class='row'>
                                            <div class='col-md-12' id="pre-batchtitletext"></div>
                                    </div>
                                    <div class='row'>
                                        <div class='col-md-12' id="pre-RadioDiv"></div>
                                    </div>-->
                                    <div class='row'>
                                            <div class='col-md-6' ></div>
                                            <div class='col-md-6' id="pre-assignbuttondiv"></div>
                                        </div> 
                                </div> 
                               
                            </div>
                            
                          </div>
                         
                          
                      </div>
                      <div class='col-md-1'>

                   
                           <div class='row-fluid'>

                      </div>
                    </div>
                      <div class='col-md-6'>
                          <div class='row'>
                              <div class='col-md-12'>
                                        <div class='batchsize' ></div>
                                        <button onclick="showFeatLvlDiv()">Previous</button>
                                  </div>
                              </div>
                             
                      </div> 
                      
                   </div> 
                    
                     
            </div> 
            <div class='row-fluid'>
                    <div class='col-md-12'>

                            <div id='TableCont' class="table-responsive">
                            </div>
                    </div>
            </div>
                        
            </div>
        <div class="col-sm-1 sidenav" style='background:yellow'>side bar</div>   
    </div>
              <br>
                    
               
                    

      <!-- <footer>
		
          <div class="container-fluid" style='margin-left:15px'>
              <p><a href="#" target="blank">Contact</a> | <a href="#" target="blank">LinkedIn1</a> | <a href="#" target="blank">Twitter</a> | <a href="#" target="blank">Google+</a></p>
          </div>
     </footer>	 -->
<script>
//Global Variable
var dict = {};
var arr_feature_levels=[];
var globalfiledatalist=[];
var exp_id = {{sess_expId}};
var custom_exp_id='{{sess_custExpId}}';
var block_list = [];

// When the page will this will be the first javascript function that will be called. 
$(document).ready(function () {
    // This Will hide all the divs with class=innerchecksboxdivs
$('.innerchecksboxdivs').hide();
$('.map_select_label').hide();
$('.show_select_tag').hide();

$('#self-defined').hide();
$('#pre-defined').hide();
$('#selfbuttondiv').hide();
$('#prebuttondiv').hide();
$('#upload').prop('disabled',true);
$('#importSubdiv').hide();
//TODO@MUDABIR:
if(exp_id===""){
    $('#feat_lvl_div').hide();
    //test to see if session exp empty
    //if not, then alert that session exists
    //if ok, load the experiment details as were
    //else, set sess_expId to None
} else {
    let contin = confirm("Continue working on Experiment: "+custom_exp_id+"?");
     if(contin===false){
         alert("TO BE IMPLEMENTED")
     }else{
         showExpWIP()
     }
}


});
// Uploading file Function . 
function showImportSubdiv(){
    $('#feat_lvl_div').hide();
    $('#outputsDiv').hide();
    $('#importSubdiv').show("slide", { direction: "left" }, 1000);
}
function showFeatLvlDiv(){
    $('#feat_lvl_div').show("slide", { direction: "right" }, 1000);
    $('#outputsDiv').show("slide", { direction: "right" }, 1000);
    $('#importSubdiv').hide();
}
function showFeatureLvls(){
    $('#importSubdiv').hide();
    $('#feat_lvl_div').slideDown(500);
    $('#outputsDiv').slideDown(500);
}
function showBatchManagement(){
    $('#importSubdiv').slideDown();
    $('#feat_lvl_div').hide();
    $('#outputsDiv').hide();
}
function showExpWIP(){
    $('#cr_exp_header').html("<p1>CREATE EXPERIMENT</p1>");
    $('#cr_exp_header').append("<p>"+custom_exp_id+" is UNDER CONSTRUCITON</p>");
}
$(function () {
    $("#upload").bind("click", function () {
        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.xlsx)$/;

        if (regex.test($("#fileUpload").val().toLowerCase())) {
            if (typeof (FileReader) != "undefined") {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                    console.log(e);
                    var table = $("<table />");
                    var rows = e.target.result.split("\n");
                    console.log(rows); 
                    var filedatalist=[]
                    console.log('header',rows[0]);
                    header=rows[0];
                    header=header.split(',');
                    console.log('header',header[0]);
                    console.log('header',typeof(header));

                 

                    for (var i = 0; i < rows.length; i++) {
                       
                        console.log(rows[i]);
                        filedatalist.push(rows[i]);
 
                        
                        var row = $("<tr />");
                        var cells = rows[i].split(",");
                        for (var j = 0; j < cells.length; j++) {
                            var cell = $("<td />");
                            cell.html(cells[j]);
                            row.append(cell);
                        }
                         table.append(row);
                         console.log($(this))
                         
                    }
                        $('#upload').prop('disabled',true);
                        
                        $('#showfiledata').html('');
                        $('#showfiledata').append(table);
  
                        var select_tag1 = $('<select id="s1"/>');
                        $('<option />', {value: "", text:"None"}).appendTo(select_tag1);
                        for(var col in header) {

                            $('<option />', {value: col, text: header[col]}).appendTo(select_tag1);
                        }
                        var select_tag2 = $('<select id="s2" />');
                        $('<option />', {value: "", text:"None"}).appendTo(select_tag2);
                        for(var col in header) {
                            $('<option />', {value: col, text: header[col]}).appendTo(select_tag2);
                        }
                        var select_tag3 = $('<select id="s3"/>');
                        $('<option />', {value: "", text:"None"}).appendTo(select_tag3);
                        for(var col in header) {
                            $('<option />', {value: col, text: header[col]}).appendTo(select_tag3);
                        }
                        $('#show_s1').append(select_tag1);
                        $('#show_s2').append(select_tag2);
                        $('#show_s3').append(select_tag3);
                        var proceedbtn= document.createElement("BUTTON");
                        var proceedStr="Process Import"
                        var text = document.createTextNode(proceedStr);
                        proceedText = proceedbtn.appendChild(text)
                        proceedbtn.onclick = function() {postExpData()};
                       // proceedbtn.classList.add("");

                        $('#proceedbtndiv').append(proceedbtn)
                        $('.map_select_label').show();
                        $('.show_select_tag').show();
                       //$('.show_select_tag').html('');
                       //$('.show_select_tag').append(select_tag);
                       
                    setFileDataList(filedatalist);
                    // for (var i = 0; i < header.length; i++) {
                    //     var radioBtn = $('<input type="radio" name="'+header[i]+'" value="'+header[i]+'"\
                    //      onclick=radioBtnFunc($(this).attr("value"),'+JSON.stringify(arrlist)+')>'+header[i]+'</input>');
                    //     //radioBtn.appendTo('#RadioDiv');

                    //     $("#RadioDiv").append(radioBtn);

                    // }

// 
//                      console.log("arr",arrlist);
//                      console.log("arr",typeof(arrlist)); 

                    
                     
                     
                     

   
                }
                reader.readAsText($("#fileUpload")[0].files[0]);
            }
             else {
                alert("This browser does not support HTML5.");
            }
        } 
        else {
            alert("Please upload a valid CSV file.");
        }
    });
});    
function postExpData(){
    var custom_id=$('#s1').children('option:selected').text();
    var email=$('#s2').children('option:selected').text() ;
    var batch_field=$('#s3').children('option:selected').text();
    var filedata=getFileDataList();
    filedata.push(custom_id);
    filedata.push(email);
    filedata.push(batch_field);

    $.ajax({
                    type: 'POST',
                    dataType: "json",
                    'data': {
                    'csvfiledata': JSON.stringify(filedata),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    // the ajax call is sent to subdetails url name in the post function.  
                    //url: "{% url 'createnewexp' %}",
                    url: "{% url 'import_subjects' %}",
                    success: function(data){
                        console.log("<<---SUBJECT IMPORT POST WAS GREAT!--->>");
                        console.log(data)
                        for(var i in data){
                            console.log("data:",i,data[i]);
                        }
                        if(exp_id===""){
                            exp_id=data['exp_id'];
                            custom_exp_id=data['custom_exp_id'];
                            showExpWIP();
                        }
                        if(data['batches']!==""){
                            var tab_batches = $("<table />");
                            var head_row = $("<tr />");
                            var head_sno_col = $("<th />");
                            head_sno_col.html("Batches")
                            head_row.append(head_sno_col)
                            var head_lset_col = $("<th />");
                            head_lset_col.html("Subject Count")
                            head_row.append(head_lset_col)
                            tab_batches.append(head_row)
                            var totCount = 0;
                            for(var j in data['batches']){
                                var btch_row = $("<tr />");
                                var btch_cell = $("<td />");
                                btch_cell.html(j);
                                btch_row.append(btch_cell);
                                var count_cell = $("<td />");
                                var btch_count = data['batches'][j];
                                count_cell.html(btch_count);
                                totCount += btch_count;
                                btch_row.append(count_cell);
                                tab_batches.append(btch_row)
                            }
                            total_row = $("<tr />");
                            total_label = $("<td />");
                            total_label.html('Total');
                            total_row.append(total_label);
                            total_cell = $("<td />");
                            total_cell.html(totCount);
                            total_row.append(total_cell);
                            tab_batches.append(total_row);
                            $('.batchsize').html('');
                            $('.batchsize').append(tab_batches);
                        }
                    }
                     
                    }); 
    
    
    
}
function selfpreDivOpt(){
    
    
    
    // if ((sel3=='')){
        

                        

    //     var selfbutton= document.createElement("BUTTON");
    //     var text = document.createTextNode("Self Defined ");
    //     selfbutton.appendChild(text)
    //     selfbutton.onclick = function() {switchVisible($('#self-defined'),header)};
    //     selfbutton.classList.add("barbutton");
    //     $('#selfbuttondiv').append(selfbutton).slideDown(1000).fadeIn(1000);
    
    // }
    // else{
    //     var prebutton= document.createElement("BUTTON");
    //     var text = document.createTextNode("PreDefined");
    //     prebutton.appendChild(text)

    //     prebutton.onclick = function() {switchVisible($('#pre-defined'),header)};
    //     prebutton.classList.add("barbutton");
    //     $('#predefbuttondiv').append(prebutton).slideDown(1000).fadeIn(1000);
    // }
    
    
    

    

    

   
   
                  
}
// Switch Function to show and hide self and pre defined divs. 
function switchVisible(obj,header) {
    if (obj) {
        console.log("swvob",obj);
        console.log('header',header)
        console.log('id',obj.is("#self-defined") )
        if (obj.attr("id") === "self-defined" &&  obj.is(":hidden")) {
            console.log("in if");
            var batchtitlename=$('<label>Batch Name:</label>');
            var batchtitleinput = $('<input class="crtinput" type="text" name="batchtitle" value="Batch" placeholder="Batch" id="selfbatchtitleid">');
            var batchnumname=$('<label>Num of Batches:</label>');
            var batchnuminput = $('<input type="text" class="crtinput" name="batchnum" value="2" placeholder="2"  id="selfbatchnumid" >');
            var batchlabelname=$('<label>Label Batches:</label>');
            var batchlabelinput = $('<input type="text" class="crtinput" name="batchlabel"  id="selfbatchlabelid" >');
            var selfassignbutton= $('<button id="selfassignbutton"onclick=selfAssignBatch()>Make Batch</button>') ;
            
            $('#batchtitle_name').append(batchtitlename);
            $('#batchtitle_input').append(batchtitleinput);
            $('#batchnum_name').append(batchnumname);
            $('#batchnum_input').append(batchnuminput);
            $('#batchlabel_name').append(batchlabelname);
            $('#batchlabel_input').append(batchlabelinput);
            $('[name=batchlabel]').val('1,2');
            $('#self-assignbuttondiv').append(selfassignbutton);

            

        
            $('#self-defined').show(1000);

           // document.getElementById('self-defined').style.display = 'block';
            $('#pre-defined').hide( 1000 );
            $('#pre-batchtitletext').empty();
            $('#pre-RadioDiv').empty();
            $('#pre-assignbuttondiv').empty();

            
            //document.getElementById('pre-defined').style.display = 'none';
        }
        else if (obj.attr("id") === "pre-defined" &&  obj.is(":hidden")) {
            
           // $('[name=batchlabel]').remove();
           $('#self-defined').hide( 1000 );
            $('#batchtitle_name').empty();
            $('#batchtitle_input').empty();
            $('#batchnum_name').empty();
            $('#batchnum_input').empty();
            $('#batchlabel_name').empty();
            $('#batchlabel_input').empty();
            $('#self-assignbuttondiv').empty();


           // In future delete this block of code. @TODO
        //    var batchtitle=$('<p>Select one of the Fields for Batch Assigning</p>');
        //    $('pre-batchtitletext').append(batchtitle);
        //    for (var i = 0; i < header.length; i++) {
        //             var radioBtn = $('<input type="radio" name="'+header[i]+'" value="'+header[i]+'"\
        //             onclick="radioBtnFunc($(this))"\
        //             >'+header[i]+'</input>');
        //             //radioBtn.appendTo('#RadioDiv');

        //             $("#pre-RadioDiv").append(radioBtn);

        //         }
            var sel1T=$('#s1').children('option:selected').text();
            var sel2T=$('#s2').children('option:selected').text();
            var sel3T=$('#s3').children('option:selected').text();
            $('#custom_label_id1').append('Customid');
            $('#custom_label_id1').append('-->');
            $('#custom_tag_id1').append(sel1T);
            $('#email_label_id1').append('Email');
            $('#email_label_id1').append('-->');
            $('#email_tag_id1').append(sel2T);
            $('#batchT_label_id1').append('Batch Title');
            $('#batchT_label_id1').append('-->');
            $('#batchT_tag_id1').append(sel3T);
            
            var assignbutton= $('<button onclick=preAssignBatch('+JSON.stringify(sel1T)+','+JSON.stringify(sel2T)+','+JSON.stringify(sel3T)+')>Make Batch</button>') ;
            assignbutton.fadeIn(300);
            $('#pre-assignbuttondiv' ).append(assignbutton) ;
            $('#pre-defined').show(1000);
           // document.getElementById('pre-defined').style.display = 'block';
            }   
    }
}
//  
function selfAssignBatch(){
    var filedata=getFileDataList();
    console.log('filedata',filedata);
    var fieldname=$('#selfbatchtitleid').val();
    console.log('fieldname',fieldname);
    var fieldnum=$('#selfbatchnumid').val();
    console.log('fieldnum',fieldnum);
    var fieldlabel=$('#selfbatchlabelid').val();
    console.log('fieldlabel',fieldlabel);
    console.log(typeof(fieldlabel));
    var assigntype='self';
    filedata.push(fieldname);
    filedata.push(fieldnum);
    filedata.push(fieldlabel);
    filedata.push(assigntype);
    console.log(filedata);
    refreshFileDataList();
    $.ajax({
                    type: 'POST',
                    dataType: "json",
                    'data': {
                    'csvfiledata': JSON.stringify(filedata),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    // the ajax call is sent to subdetails url name in the post function.  
                    url: "{% url 'uploadsamplefile' %}",
                    success: function(data){
                      
                        console.log(JSON.parse(data[1]))
                        
                        dataframe_table=JSON.parse(data[1])
                        var mydata = eval(dataframe_table);
                        var table = $.makeTable(mydata);
                        transposeTable(table)
                        
                        $(table).appendTo("#TableCont");
                        $('#mytable').DataTable({
                           
                            "bLengthChange": false,
                            "bFilter": false,
                            "pageLength": 5
                            });
                        groups=JSON.parse(data[2]);

                        for (var obj in groups)  {
                            console.log(obj);
                            console.log(groups[obj]);
                        }      
                       }
                    }); 
    


}
//  
function radioBtnFunc(radiovalue){
        console.log('radiovalue',radiovalue.attr('value')) ;
        var radioinput_value=radiovalue.attr('value'); 
        var assignbutton= $('<button onclick=preAssignBatch('+JSON.stringify(radioinput_value)+')>Make Batch And assign to blocks</button>') ;
                         assignbutton.fadeIn(300);
                         $('#pre-assignbuttondiv' ).append(assignbutton) ;
    
}

function preAssignBatch(sel1T,sel2T,sel3T){
    var filedata=getFileDataList();
    console.log(filedata);
    // var fieldname=radioinput_value;
    // console.log("fieldname",fieldname);
    
    console.log(filedata);
    filedata.push(sel1T);
    filedata.push(sel2T);
    filedata.push(sel3T);
    filedata.push('pre');
    console.log(filedata);
    refreshFileDataList();
    $.ajax({
                    type: 'POST',
                    dataType: "json",
                    'data': {
                    'csvfiledata': JSON.stringify(filedata),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    // the ajax call is sent to subdetails url name in the post function.  
                    url: "{% url 'uploadsamplefile' %}",
                    success: function(data){
                      
                       //create table
                        
                        //  for (var i in data){// 
                        //     // row 
                             
                        //      console.log(i); // key RollNO  Individual cells. 
                        //      // add all to the row.    
                        //      console.log(Object.values(data[i]).length);  // Value {0: 1239123}
                        //      for (var j in data[i] ){  
                        //          console.log(data[i][j]);
                        //      }
                        //  }
                        
                        var mydata = eval(data);
                        var table = $.makeTable(mydata);
                        transposeTable(table)
                        $(table).appendTo("#TableCont");
                      
                
                       }
                     
                    }); 
    
}

$.makeTable = function (mydata) {
    var table = $('<table  id="mytable" class="table table-bordred table-striped">');
    var thead = $('<thead>');

    var tblHeader = "<tr>";
        
    for (var k in mydata) tblHeader += "<th>" + k + "</th>";

    tblHeader += "</tr>";
    $(tblHeader).appendTo(thead);
    $(thead).appendTo(table)
    
    var tbody = $('<tbody>');
   

    $.each(mydata, function (index, value) {
        var TableRow = "<tr>";
                
        $.each(value, function (key, val) {
            TableRow += "<td>" + val + "</td>";
    
        });
        TableRow += "</tr>";
        $(TableRow).appendTo(tbody);
        // $(table).append(TableRow);
        

    });

    $(tbody).appendTo(table);
    return ($(table));
};

function transposeTable(table) {
        var $this = table.children('tbody');
        var newrows = [];
        $this.find("tr").each(function(){
            var i = 0;
            $(this).find("td").each(function(){
                i++;
                if(newrows[i] === undefined) { newrows[i] = $("<tr></tr>"); }
                newrows[i].append($(this));
            });
        });
        $this.find("tr").remove();
        $.each(newrows, function(){
            $this.append(this);
        });
  
}

function setFileDataList(filedatalist){
    globalfiledatalist=filedatalist
}
function emptyFileDataList(){
  globalfiledatalist=[];
}
function getFileDataList(){
    return globalfiledatalist;
   
}
function refreshFileDataList (){
  var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;

if (regex.test($("#fileUpload").val().toLowerCase())) {
    if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.onload = function (e) {
          
            var rows = e.target.result.split("\n");
            var filedatalist=[];

            for (var i = 0; i < rows.length; i++) {
               
                console.log(rows[i]);
                filedatalist.push(rows[i]);

            }
            
            setFileDataList(filedatalist);
            

        }
        reader.readAsText($("#fileUpload")[0].files[0]);
    }
     else {
        alert("This browser does not support HTML5.");
    }
} 
else {
    alert("Please upload a valid CSV file.");
}
}
function chooseFileFunc(){
  $('#upload').prop('disabled',false);
}

// Outercheckbox function 
// This function gets 2 arguments when called val and id attribute of input type=checkbox
// having id based on the feature.id.
// It is called through onclick function. 
function outerCheckBox(outercheckval,outercheckid) {
console.log("checkbox");
console.log(outercheckval);
console.log(outercheckid);
// Ajax call is made to send the outercheckboxid to the controller. 
// The controller will fetch the sub-details of that feature from model and return back in
// in success function. 
// Success funtion will first check if the outercheckbox is checked or unchecked. 
// If unchecked it'll simply hide the innercheckboxdiv or do nothing as by default its hidden.
// else will populate data in that div and show to user.  
$.ajax({
type: 'POST',
dataType: "json",
'data': {
'd': JSON.stringify(outercheckval),
'csrfmiddlewaretoken': '{{ csrf_token }}',
},
// the ajax call is sent to subdetails url name in the post function.  
url: "{% url 'subdetails' %}",
success: function(data){
    console.log("success");
    var outerckbox = $('#'+outercheckid);
    console.log('outercheckbox obj',outerckbox);
    dict[outercheckval]=data
    console.log('value of key in dic',dict[outercheckval]);
    // checking if the user has checked or not. 

if (outerckbox.is(':checked')) {
    //alert('You Checked');
    console.log('outercheckval',outercheckval);
    console.log('data retrieved',data)
    dict[outercheckval]=data
    if (data==null){
        dict[outercheckval]=[0,1]
    }
    console.log('dictionary',dict)
    // calling innercheckboxdivs. 
    // these divs basically come after outercheckbox that contain innerchecks.
    // outercheck id and the data is sent to this function.
    // This function shows the innerChecksdivs after including and populating data in 
    // innerchecks.
    // todo: change the name of innercheckboxdivs name as it seems like it is refering to
    // div inside inner checks...
    showInnerCheckBoxDivs(outercheckid,data);
} else {
    //alert('You Un-Checked it');
    // For now its purpose is simply to hide the innercheckdivs.  
    hideInnerCheckBoxDivs(outercheckid);
    console.log(outercheckval);
    dict[outercheckval]=null;
    if (dict[outercheckval]==null  ){
        delete dict[outercheckval];
        console.log('in else condition');  
    }
    console.log(dict)

}
}
}); 
}
function showInnerCheckBoxDivs(outercheckid,data){
console.log('#'+outercheckid+'-innercheckboxdiv')
// Creating inner checks and populating them with data. 


for (var o in data){
    console.log('A',o);
    
   
    var $ctrl =  $(document.createElement("input")).attr({
            id: o +'-innercheckbox-'+outercheckid,
            name:  '',
            value: data[o],
            text :'',
            type:  'checkbox',
            checked:true,
            onclick:"innerCheckBox($(this).attr('value'),$(this).attr('id'),\
            $(this).parent().attr('title'), $(this).parent().attr('id')\
            )"
            
    })
// adding input attributes to a div
$('#'+outercheckid+'-innercheckboxdiv').append($ctrl);
$('#'+outercheckid+'-innercheckboxdiv').append(data[o]);
$('#'+outercheckid+'-innercheckboxdiv').show();
}
}
// function that hides the divs containing innercheckbox
function hideInnerCheckBoxDivs(outercheckid){
$('#'+outercheckid+'-innercheckboxdiv').hide();
$('#'+outercheckid+'-innercheckboxdiv').empty();

}
// once the onclick function=>(innercheckbox) of inner checks are called it 
// shows three things. innercheck value , id and outer check value/title.
function innerCheckBox(innercheckval,innercheckid,outercheckdivtitle,outercheckdivid){
//console.log(innercheckval,innercheckid,outercheckdivtitle);

console.log('outercheckbox title',outercheckdivtitle)
var innercheckboxid = $('#'+innercheckid);
//var parentdiv=innercheckboxid.parent();
//var parentdivid=parentdiv.attr('id');
var temparr=outercheckdivid.split('-');
console.log('outercheck id ',temparr[0])
var innercheckboxid_elem = document.getElementById(innercheckboxid);

//console.log("outerchekboxid-",outercheckid );
console.log("innercheckbox-",innercheckboxid );
// checking if the user has checked or not. 

// if ($(innercheckboxid).is(':checked')) {
    console.log('#'+temparr[0])
    // $('#'+temparr[0]).prop('checked',true);
    
if ($(innercheckboxid).prop('checked') == true){
    if (dict[outercheckdivtitle] == null) {
            dict[outercheckdivtitle]=[]
        }   
    //alert('You have Checked innercheckbox');
    arr_feature_levels=dict[outercheckdivtitle];
    console.log('Specific dict in Checked',dict[outercheckdivtitle]);
    console.log('insert',arr_feature_levels);
    arr_feature_levels.push(innercheckval);
    dict[outercheckdivtitle]=arr_feature_levels;
    console.log('arr',arr_feature_levels);
    console.log('All dict in checked condition.',dict);
    
    
   

        
    
} else if ($(innercheckboxid).prop('checked') == false) {

    //alert('You UNNNChecked innercheckbox');
    arr_feature_levels=dict[outercheckdivtitle];
    console.log('Specific dict in UnChecked',dict[outercheckdivtitle]);
    console.log('arr',arr_feature_levels);
    console.log(innercheckval);
    var index = $.inArray(innercheckval, arr_feature_levels);
        if (index != -1) {
            var removedvalue=arr_feature_levels.splice(index, 1);
            console.log('removedvalue',removedvalue);
      
        

        }
    console.log('del arr',arr_feature_levels);  
    console.log('del arr',arr_feature_levels.length);
    if (arr_feature_levels.length===0){
        delete  dict[outercheckdivtitle];
        console.log('condition check');
        console.log('deleted dic',dict);
        

    }
    else{ 
        dict[outercheckdivtitle]=arr_feature_levels;
        console.log('dict',dict);
        
    }
    

}
}

function sendFeatureLevels(){
$.ajax({
type: 'POST',
dataType: "json",
'data': {
'dict': JSON.stringify(dict,undefined,''),
'exp_id': exp_id,
'csrfmiddlewaretoken': '{{ csrf_token }}',
},
// the ajax call is sent to subdetails url name in the post function.  
url: "{% url 'createexp' %}",
success: function(data){
    console.log("<<---FEATURES POSTED SUCCESSFULLY--->>");
    console.log(data)
    //console.log('Blocks---> ',data);
    for(var i in data){
        console.log("Hi:",i,data[i])
    }
    if(exp_id===""){
        exp_id = data['exp_id'];
        custom_exp_id = data['custom_exp_id'];
        showExpWIP()
    }
    if (data['block_list']!=null){
        var tab_blocks = $("<table />");
        var head_row = $("<tr />");
        var head_sno_col = $("<th />");
        head_sno_col.html("Block No")
        head_row.append(head_sno_col)
        var head_lset_col = $("<th />");
        head_lset_col.html("Feature Level Combination")
        head_row.append(head_lset_col)
        tab_blocks.append(head_row)
        blkList = data['block_list']
        for(var i = 0; i < blkList.length; i++){
            var blk_row = $("<tr />");
            var blk_no_cell = $("<td />");
            console.log("Block: ",blkList[i]['serial_no'])
            blk_no_cell.html(blkList[i]['serial_no']);
            blk_row.append(blk_no_cell);
            var blk_lSet_cell = $("<td />");
            var blk_lSet = blkList[i]['levels_set']
            blk_lSet_cell.html('')
            for(var j = 0; j < blk_lSet.length; j++){
                blk_lSet_cell.append(blk_lSet[j])
                if(j!=(blk_lSet.length-1)){
                    blk_lSet_cell.append(", ")
                }
            }
            blk_row.append(blk_lSet_cell);
            tab_blocks.append(blk_row);
        }
        console.log(tab_blocks)
        $('#blocksBreakUp').html('');
        $('#blocksBreakUp').append(tab_blocks);
    }
}
}); 
}

function sendFilePath(id){
        console.log(id);
        console.log($('#'+id).val().replace(/C:\\fakepath\\/i, ''));
        var filepath=$('#'+id).val().replace(/C:\\fakepath\\/i, '');
        console.log(filepath);
        $.ajax({
        type: 'POST',
        dataType: "json",
        'data': {
        'dict': JSON.stringify(filepath),
        'csrfmiddlewaretoken': '{{ csrf_token }}',
        },
        // the ajax call is sent to subdetails url name in the post function.  
        url: "{% url 'createexp' %}",
        success: function(data){}
        
        }); 

      }
</script>
<script type="text/javascript" src="{% static 'webapp/createexp/DataTables/datatables.min.js' %}"></script>
<link rel="stylesheet" type="text/css" src="{% static 'webapp/createexp/DataTables/datatables.css' %}"/>
 
{%endblock%}