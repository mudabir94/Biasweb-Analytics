{% extends "webapp/crudexperiment/base_experiment.html" %}
{% block content %}
{%load static from staticfiles%}
<div class="container-fluid text-center">    
      <div class="row content">
          <div class="col-sm-2 sidenav" style='background:teal'></div>
          <div class="col-sm-9  col-md-9 col-lg-9 col-xs-9 text-left" > 
                  <div class ="row-fluid">     
                      <div class ="row">   
                            <div class='col-md-12' >
                            <p1>Create Experiment </p1> <!-- Show Experiment Id here e.g. ses-007 (admin id) + experiment no. (5 digits)-->
                            </div>  
                        </div>
                      <div class ="row"> 
                          <div class='col-md-12' >    
                            <p1>Admin id {{admin_id}}</p1>
                          </div>                            
                      </div>
                      <div class ="row"> 
                          <div class='col-md-12' >    
                            <p1>Experiment id {{experiment_id}}</p1>
                          </div>                            
                      </div>
                  </div>
                  <!-- <div class="row-fluid" style="background:thistle;">  
                        <div class='row-fluid' >
                          <div class="col-md-3">
                            <input type=text/>
                          </div>
                          <div class="col-md-9">
                          No of Experiment
                          </div>
                        </div> 
                        <div class='row-fluid' >
                            <div class="col-md-3">
                              <input type=text/>
                            </div>
                            <div class="col-md-9">
                            Subject Capicity
                            </div>
                        </div> 
                  </div> -->
                  <br>
                  <div class='row-fluid' style="background: cadetblue">
                    <div class='row'>
                      <div class='col-md-5'>
                         
                          <!-- <form action="{%url 'uploadsamplefile'%}" method="post" enctype="multipart/form-data">
                              {% csrf_token %}

                            File: <input type="file" name="myfile"><br>
                            
                            <button type="submit">Submit</button><br>
                          </form>
                          -->
                          <input type="file" id="fileUpload" />
                          <input type="button" id="upload" value="Upload" />

                          <hr />
                          <div id="dvCSV">
                          </div>
                      </div>
                      <div class='col-md-1'>

                      <!-- <button>Upload</button> -->
                      <div class='row'>

                      </div>
                    </div>
                      <div class='col-md-6'></div> 
                        
                    </div>
                  </div>
              <br>
                    <div class='row-fluid' style="background:peru;">
                      {% for feature in platformfeatobj%}
                          <div class='row-fluid'>
                              <div class='col-md-12'>
                                  <input type="checkbox"  id='{{feature.id}}' action='{%url "createexp"%}'
                                        method="post" 
                                        value="{{feature.feature_symbol}}" 
                                        onclick="outerCheckBox($(this).attr('value'),$(this).attr('id'))">
                                        {{feature.feature_name}} 
                                        <div  id='{{feature.id}}-innercheckboxdiv' class='innerchecksboxdivs' title='{{feature.feature_symbol}}'>
                                        </div>
                                  </input>
                                  <br>
                              </div>
                          </div>
                          {%endfor%}
                    
                          <div class='row-fluid'>

                              <button onclick='sendFeatureLevels()'> Set Feature Levels </button>
                          </div>  
                      </div>
                   
          </div>
          
          <div class="col-sm-1 sidenav" style='background:yellow'>side bar</div>
      </div>
</div>
      <footer>
		
          <div class="container-fluid" style='margin-left:15px'>
              <p><a href="#" target="blank">Contact</a> | <a href="#" target="blank">LinkedIn1</a> | <a href="#" target="blank">Twitter</a> | <a href="#" target="blank">Google+</a></p>
          </div>
     </footer>	
<script>
      $(function () {
    $("#upload").bind("click", function () {
        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
        if (regex.test($("#fileUpload").val().toLowerCase())) {
            if (typeof (FileReader) != "undefined") {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var table = $("<table />");
                    var rows = e.target.result.split("\n");
                    for (var i = 0; i < rows.length; i++) {
                        var row = $("<tr />");
                        var cells = rows[i].split(",");
                        for (var j = 0; j < cells.length; j++) {
                            var cell = $("<td />");
                            cell.html(cells[j]);
                            row.append(cell);
                        }
                        table.append(row);
                    }
                    $("#dvCSV").html('');
                    $("#dvCSV").append(table);
                }
                reader.readAsText($("#fileUpload")[0].files[0]);
            } else {
                alert("This browser does not support HTML5.");
            }
        } else {
            alert("Please upload a valid CSV file.");
        }
    });
});    



      //Global Variable
      var dict = {};
      var arr_feature_levels=[];
      // When the page will this will be the first javascript function that will be called. 
       $(document).ready(function () {
         // This Will hide all the divs with class=innerchecksboxdivs
        $('.innerchecksboxdivs').hide();
        });
      // Outercheckbox function 
      // This function gets 2 arguments when called val and id attribute of input type=checkbox
      // having id based on the feature.id.
      // It is called through onclick function. 
      function outerCheckBox(outercheckval,outercheckid) {
        console.log("checkbox");
        console.log(outercheckval);
        console.log(outercheckid);
      // Ajax call is made to send the outercheckboxid to the controller. 
      // The controller will fetch the sub-details of that feature from model and return back in
      // in success function. 
      // Success funtion will first check if the outercheckbox is checked or unchecked. 
      // If unchecked it'll simply hide the innercheckboxdiv or do nothing as by default its hidden.
      // else will populate data in that div and show to user.  
       $.ajax({
       type: 'POST',
       dataType: "json",
       'data': {
       'd': JSON.stringify(outercheckval),
       'csrfmiddlewaretoken': '{{ csrf_token }}',
      },
      // the ajax call is sent to subdetails url name in the post function.  
       url: "{% url 'subdetails' %}",
       success: function(data){
       console.log("success");
       var outerckbox = $('#'+outercheckid);
       console.log(outerckbox);
       dict[outercheckval]=data
       console.log(dict[outercheckval]);
        // checking if the user has checked or not. 
        if (outerckbox.is(':checked')) {
           alert('You Checked');
           console.log('asdasd',outercheckval);
           console.log(data)
           dict[outercheckval]=data
           if (data==null){
             dict[outercheckval]=[0,1]
           }
           console.log(dict)
            // calling innercheckboxdivs. 
            // these divs basically come after outercheckbox that contain innerchecks.
            // outercheck id and the data is sent to this function.
            // This function shows the innerChecksdivs after including and populating data in 
            // innerchecks.
            // todo: change the name of innercheckboxdivs name as it seems like it is refering to
            // div inside inner checks...
            showInnerCheckBoxDivs(outercheckid,data);
        } else {
            alert('You Un-Checked it');
            // For now its purpose is simply to hide the innercheckdivs.  
            hideInnerCheckBoxDivs(outercheckid);
            console.log(outercheckval);
            dict[outercheckval]=null;
            if (dict[outercheckval]==null  ){
              delete dict[outercheckval];
              console.log('in else condition');  
           }
           console.log(dict)

        }
       }
       }); 
      }
      function showInnerCheckBoxDivs(outercheckid,data){
        console.log('#'+outercheckid+'-innercheckboxdiv')
        // Creating inner checks and populating them with data. 
        for (var o in data){
          console.log('A',o);
          var $ctrl =  $(document.createElement("input")).attr({
                    id:  o+'-innercheckbox',
                    name:  '',
                    value: data[o],
                    text :'',
                    type:  'checkbox',
                    checked:true,
                    onclick:"innerCheckBox($(this).attr('value'),$(this).attr('id'),\
                    $(this).parent().attr('title'),\
                    )"
                    
            })
        // adding input attributes to a div
        $('#'+outercheckid+'-innercheckboxdiv').append($ctrl);
        $('#'+outercheckid+'-innercheckboxdiv').append(data[o]);
        $('#'+outercheckid+'-innercheckboxdiv').show();
        }
      }
      // function that hides the divs containing innercheckbox
      function hideInnerCheckBoxDivs(outercheckid){
        $('#'+outercheckid+'-innercheckboxdiv').hide();
        $('#'+outercheckid+'-innercheckboxdiv').empty();

      }
      // once the onclick function=>(innercheckbox) of inner checks are called it 
      // shows three things. innercheck value , id and outer check value/title.
      function innerCheckBox(innercheckval,innercheckid,outercheckdivtitle){
        //console.log(innercheckval,innercheckid,outercheckdivtitle);
        var innercheckboxid = $('#'+innercheckid);
        var innercheckboxid_elem = document.getElementById(innercheckboxid);

        //console.log("outerchekboxid-",outercheckid );
        console.log("innercheckbox-",innercheckboxid );
        // checking if the user has checked or not. 
        if (innercheckboxid.checked==true) {
            if (dict[outercheckdivtitle] == null) {
                   dict[outercheckdivtitle]=[]
               }   
            alert('You have Checked innercheckbox');
            arr_feature_levels=dict[outercheckdivtitle];
            console.log('Specific dict in Checked',dict[outercheckdivtitle]);
            console.log('insert',arr_feature_levels);
            arr_feature_levels.push(innercheckval);
            dict[outercheckdivtitle]=arr_feature_levels;
            console.log('arr',arr_feature_levels);
            console.log('All dict in checked condition.',dict);

            
        } else {

            alert('You UNNNChecked innercheckbox');
            arr_feature_levels=dict[outercheckdivtitle];
            console.log('Specific dict in UnChecked',dict[outercheckdivtitle]);
            console.log('arr',arr_feature_levels);
            console.log(innercheckval);
            var index = $.inArray(innercheckval, arr_feature_levels);
              if (index != -1) {
                  var removedvalue=arr_feature_levels.splice(index, 1);
                  console.log('removedvalue',removedvalue);
              }

            console.log('del arr',arr_feature_levels);
            if (arr_feature_levels.length==0){
              delete  dict[outercheckdivtitle];
              console.log('condition check');
              console.log('deleted dic',dict);
              

            }
            else{ 
              dict[outercheckdivtitle]=arr_feature_levels;
              console.log('dict',dict);
               
            }
            

        }
      }

      function sendFeatureLevels(){
        $.ajax({
       type: 'POST',
       dataType: "json",
       'data': {
       'dict': JSON.stringify(dict),
       'csrfmiddlewaretoken': '{{ csrf_token }}',
      },
      // the ajax call is sent to subdetails url name in the post function.  
       url: "{% url 'createexp' %}",
       success: function(data){}
       
       }); 
      }


      function sendFilePath(id){
        console.log(id);
        console.log($('#'+id).val().replace(/C:\\fakepath\\/i, ''));
        var filepath=$('#'+id).val().replace(/C:\\fakepath\\/i, '');
        console.log(filepath);
        $.ajax({
        type: 'POST',
        dataType: "json",
        'data': {
        'dict': JSON.stringify(filepath),
        'csrfmiddlewaretoken': '{{ csrf_token }}',
        },
        // the ajax call is sent to subdetails url name in the post function.  
        url: "{% url 'createexp' %}",
        success: function(data){}
        
        }); 

      }
</script>
{%endblock%}